<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/png" sizes="32x32" href="/Images/logo.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email Verification - Baobab Online Academy</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700;900&family=Open+Sans:wght@300;400;600;700&family=Kalam:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --baobab-brown:#8D4004;--canopy-green:#2E7D32;--sunset-gold:#F57C00;--trunk-gray:#5D4037;
      --earth-cream:#FFF8E1;--desert-orange:#FF5722;--white:#FFFFFF;--deep-charcoal:#263238;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Open Sans',sans-serif;color:var(--deep-charcoal);
      background:linear-gradient(135deg,var(--canopy-green),var(--baobab-brown));
      min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .card{background:var(--white);border-radius:24px;padding:40px;max-width:680px;width:100%;
      text-align:center;border:3px solid var(--sunset-gold);box-shadow:0 20px 50px rgba(0,0,0,.3)}
    .logo{display:inline-flex;align-items:center;gap:12px;margin-bottom:10px}
    .logo-icon{width:44px;height:44px;background:var(--canopy-green);color:#fff;border-radius:10px;display:grid;place-items:center}
    .logo-text{font-family:'Merriweather',serif;color:var(--baobab-brown);font-weight:700;font-size:22px}
    .title{font-family:'Merriweather',serif;color:var(--baobab-brown);font-size:26px;margin:8px 0 12px}
    .msg{color:var(--trunk-gray);line-height:1.7;margin-bottom:16px}
    .bigicon{font-size:3.4rem;margin-bottom:10px}
    .loading{color:var(--sunset-gold);animation:spin 1s linear infinite}
    .success{color:var(--canopy-green)}
    .error{color:var(--desert-orange)}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hidden{display:none}
    .details{background:var(--earth-cream);border:2px solid rgba(245,124,0,.3);padding:16px;border-radius:14px;text-align:left;margin:14px 0}
    .details h4{color:var(--sunset-gold);margin-bottom:8px;font-family:'Merriweather',serif}
    .details ul{list-style:none}
    .details li{margin:8px 0;display:flex;gap:10px;align-items:center;color:var(--trunk-gray)}
    .btn{display:inline-flex;align-items:center;gap:10px;padding:12px 22px;border-radius:26px;
      font-weight:600;text-decoration:none;cursor:pointer;border:2px solid transparent;margin:6px;transition:.25s}
    .btn-primary{background:var(--baobab-brown);color:#fff;border-color:var(--baobab-brown)}
    .btn-primary:hover{filter:brightness(.92);transform:translateY(-2px)}
    .btn-outline{background:transparent;color:var(--baobab-brown);border-color:var(--baobab-brown)}
    .btn-outline:hover{background:var(--baobab-brown);color:#fff}
    .muted{opacity:.85;font-size:.95rem;margin-top:14px}
    @media (max-width:576px){.card{padding:24px}.title{font-size:22px}.bigicon{font-size:3rem}}
  </style>
</head>
<body>
  <div class="card">
    <div class="logo">
      <div class="logo-icon"><i class="fas fa-tree"></i></div>
      <div class="logo-text">Baobab Academy</div>
    </div>

    <!-- Loading -->
    <div id="loading">
      <i class="fas fa-spinner bigicon loading"></i>
      <h1 class="title">Verifying your email…</h1>
      <p class="msg">Please wait while we process your verification.</p>
    </div>

    <!-- Success -->
    <div id="ok" class="hidden">
      <i class="fas fa-check-circle bigicon success"></i>
      <h1 class="title">Email verified!</h1>
      <p class="msg">Your account is active. Redirecting to your dashboard…</p>
      <a class="btn btn-primary" href="/parent-dashboard.html"><i class="fas fa-tachometer-alt"></i> Go to dashboard</a>
    </div>

    <!-- Error -->
    <div id="fail" class="hidden">
      <i class="fas fa-exclamation-triangle bigicon error"></i>
      <h1 class="title">Verification failed</h1>
      <p class="msg" id="errText">The link seems invalid or expired.</p>
      <div class="details">
        <h4><i class="fas fa-tools"></i> Try this:</h4>
        <ul>
          <li><i class="fas fa-envelope"></i> Request a new verification email</li>
          <li><i class="fas fa-link"></i> Make sure you're using the latest email</li>
          <li><i class="fas fa-refresh"></i> Check your spam folder</li>
        </ul>
      </div>
      <a class="btn btn-outline" href="/"><i class="fas fa-home"></i> Return home</a>
    </div>

    <p class="muted">Need help? Email parents@baobabonlineacademy.com or call +234 (0) 816 501 1291</p>
  </div>

  <script>
  const SUPABASE_URL = 'https://vcxdkacxbjsgaoxbhsip.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZjeGRrYWN4YmpzZ2FveGJoc2lwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MDQ5ODMsImV4cCI6MjA2ODQ4MDk4M30.T9KhHWzHZWyaZvyeFXtBu8tPLY9JOn6_wCHcH8B46FU';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = id => document.getElementById(id);
  const show = id => $(id).classList.remove('hidden');
  const hide = id => $(id).classList.add('hidden');

  function getParams() {
    const urlParams = new URLSearchParams(window.location.search);
    return {
      token: urlParams.get('token'),
      email: urlParams.get('email')
    };
  }

  async function verifyEmail(token, email) {
    console.log('Verifying token:', token, 'for email:', email);
    
    try {
      // Look up the verification token
      const { data: tokenData, error: fetchError } = await supabase
        .from('verification_tokens')
        .select('*')
        .eq('token', token)
        .eq('email', email.toLowerCase())
        .single();

      if (fetchError) {
        console.error('Database error:', fetchError);
        throw new Error('Invalid verification link or token not found');
      }

      if (!tokenData) {
        throw new Error('Verification token not found');
      }

      // Check if token expired
      const now = new Date();
      const expiresAt = new Date(tokenData.expires_at);
      
      if (now > expiresAt) {
        // Delete expired token
        await supabase
          .from('verification_tokens')
          .delete()
          .eq('token', token);
        
        throw new Error('Verification link has expired. Please request a new one.');
      }

      // Token is valid - mark user as verified
      console.log('Token is valid, marking user as verified');
      
      // Update user verification status (if users table exists)
      try {
        await supabase
          .from('users')
          .update({ 
            email_verified: true,
            email_verified_at: new Date().toISOString()
          })
          .eq('email', email.toLowerCase());
      } catch (userUpdateError) {
        console.log('Could not update user table (may not exist yet)');
      }

      // Delete the used token
      await supabase
        .from('verification_tokens')
        .delete()
        .eq('token', token);

      console.log('Email verification successful');
      return { success: true, userData: tokenData.user_data };

    } catch (error) {
      console.error('Verification error:', error);
      throw error;
    }
  }

  async function main() {
    try {
      const params = getParams();

      if (!params.token || !params.email) {
        throw new Error('Invalid verification link. Missing token or email.');
      }

      console.log('Starting verification for:', params.email);
      
      const result = await verifyEmail(params.token, params.email);
      
      // Show success
      hide('loading');
      show('ok');
      
      // Redirect after 2 seconds
      setTimeout(() => {
        window.location.href = '/parent-dashboard.html';
      }, 2000);
      
    } catch (error) {
      console.error('Main error:', error);
      
      // Show error
      hide('loading');
      show('fail');
      
      const errorText = $('errText');
      if (errorText) {
        errorText.textContent = error.message || 'Verification failed. Please try again.';
      }
    }
  }

  // Start verification when page loads
  window.addEventListener('DOMContentLoaded', main);
</script>
</body>
</html>