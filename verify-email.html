<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/png" sizes="32x32" href="/Images/logo.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email Verification - Baobab Online Academy</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700;900&family=Open+Sans:wght@300;400;600;700&family=Kalam:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --baobab-brown:#8D4004;--canopy-green:#2E7D32;--sunset-gold:#F57C00;--trunk-gray:#5D4037;
      --earth-cream:#FFF8E1;--desert-orange:#FF5722;--white:#FFFFFF;--deep-charcoal:#263238;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Open Sans',sans-serif;color:var(--deep-charcoal);
      background:linear-gradient(135deg,var(--canopy-green),var(--baobab-brown));
      min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .card{background:var(--white);border-radius:24px;padding:40px;max-width:680px;width:100%;
      text-align:center;border:3px solid var(--sunset-gold);box-shadow:0 20px 50px rgba(0,0,0,.3)}
    .logo{display:inline-flex;align-items:center;gap:12px;margin-bottom:10px}
    .logo-icon{width:44px;height:44px;background:var(--canopy-green);color:#fff;border-radius:10px;display:grid;place-items:center}
    .logo-text{font-family:'Merriweather',serif;color:var(--baobab-brown);font-weight:700;font-size:22px}
    .title{font-family:'Merriweather',serif;color:var(--baobab-brown);font-size:26px;margin:8px 0 12px}
    .msg{color:var(--trunk-gray);line-height:1.7;margin-bottom:16px}
    .bigicon{font-size:3.4rem;margin-bottom:10px}
    .loading{color:var(--sunset-gold);animation:spin 1s linear infinite}
    .success{color:var(--canopy-green)}
    .error{color:var(--desert-orange)}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hidden{display:none}
    .details{background:var(--earth-cream);border:2px solid rgba(245,124,0,.3);padding:16px;border-radius:14px;text-align:left;margin:14px 0}
    .details h4{color:var(--sunset-gold);margin-bottom:8px;font-family:'Merriweather',serif}
    .details ul{list-style:none}
    .details li{margin:8px 0;display:flex;gap:10px;align-items:center;color:var(--trunk-gray)}
    .btn{display:inline-flex;align-items:center;gap:10px;padding:12px 22px;border-radius:26px;
      font-weight:600;text-decoration:none;cursor:pointer;border:2px solid transparent;margin:6px;transition:.25s}
    .btn-primary{background:var(--baobab-brown);color:#fff;border-color:var(--baobab-brown)}
    .btn-primary:hover{filter:brightness(.92);transform:translateY(-2px)}
    .btn-outline{background:transparent;color:var(--baobab-brown);border-color:var(--baobab-brown)}
    .btn-outline:hover{background:var(--baobab-brown);color:#fff}
    .muted{opacity:.85;font-size:.95rem;margin-top:14px}
    @media (max-width:576px){.card{padding:24px}.title{font-size:22px}.bigicon{font-size:3rem}}
  </style>
</head>
<body>
  <div class="card">
    <div class="logo">
      <div class="logo-icon"><i class="fas fa-tree"></i></div>
      <div class="logo-text">Baobab Academy</div>
    </div>

    <!-- Loading -->
    <div id="loading">
      <i class="fas fa-spinner bigicon loading"></i>
      <h1 class="title">Verifying your email…</h1>
      <p class="msg">Please wait while we process your verification.</p>
    </div>

    <!-- Success -->
    <div id="ok" class="hidden">
      <i class="fas fa-check-circle bigicon success"></i>
      <h1 class="title">Email verified!</h1>
      <p class="msg">Your account is active. Redirecting to your dashboard…</p>
      <a class="btn btn-primary" href="/parent-dashboard.html"><i class="fas fa-tachometer-alt"></i> Go to dashboard</a>
    </div>

    <!-- Error -->
    <div id="fail" class="hidden">
      <i class="fas fa-exclamation-triangle bigicon error"></i>
      <h1 class="title">Verification failed</h1>
      <p class="msg" id="errText">The link seems invalid or expired.</p>
      <div class="details">
        <h4><i class="fas fa-tools"></i> Try this:</h4>
        <ul>
          <li><i class="fas fa-envelope"></i> Open the newest verification email</li>
          <li><i class="fas fa-link"></i> Click the link again from this device</li>
          <li><i class="fas fa-refresh"></i> Request a new verification email</li>
        </ul>
      </div>
      <a class="btn btn-outline" href="/"><i class="fas fa-home"></i> Return home</a>
    </div>

    <p class="muted">Need help? Email parents@baobabonlineacademy.com or call +234 (0) 816 501 1291</p>
  </div>

  <script>
  const SUPABASE_URL = 'https://vcxdkacxbjsgaoxbhsip.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZjeGRrYWN4YmpzZ2FveGJoc2lwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MDQ5ODMsImV4cCI6MjA2ODQ4MDk4M30.T9KhHWzHZWyaZvyeFXtBu8tPLY9JOn6_wCHcH8B46FU';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = id => document.getElementById(id);
  const show = id => $(id).classList.remove('hidden');
  const hide = id => $(id).classList.add('hidden');

  function params() {
    const s = new URLSearchParams(window.location.search);
    const get = k => s.get(k);
    return {
      token: get('token'),
      email: get('email')
    };
  }

  // Check if user is already verified in localStorage (cache)
  function isUserAlreadyVerified(email) {
    try {
      const userVerificationKey = `user_verification_${email.toLowerCase()}`;
      const verificationData = localStorage.getItem(userVerificationKey);
      
      if (!verificationData) return false;
      
      const data = JSON.parse(verificationData);
      return data.verified === true;
    } catch (error) {
      console.error('Error checking verification status:', error);
      return false;
    }
  }

  // Mark user as verified in localStorage (cache)
  function markUserVerified(email, userData) {
    const userVerificationKey = `user_verification_${email.toLowerCase()}`;
    
    const verificationData = {
      email: email.toLowerCase(),
      userId: userData.userId || 'temp_user_' + Date.now(),
      verified: true,
      verifiedAt: new Date().toISOString(),
      userData: userData
    };
    
    localStorage.setItem(userVerificationKey, JSON.stringify(verificationData));
    console.log('User verification cached locally:', email);
  }

  // Check localStorage for verification token (fallback method)
  function validateTokenFromLocalStorage(token, email) {
    try {
      const storedData = localStorage.getItem(`verification_${token}`);
      if (!storedData) return null;
      
      const data = JSON.parse(storedData);
      if (data.expires < Date.now()) {
        localStorage.removeItem(`verification_${token}`);
        return null;
      }
      
      if (data.email !== email.toLowerCase()) return null;
      
      return data;
    } catch (error) {
      console.error('LocalStorage token validation error:', error);
      return null;
    }
  }

  // Try to validate token from Supabase first, fall back to localStorage
  async function validateVerificationToken(token, email) {
    console.log('Validating token:', token, 'for email:', email);
    
    // First try Supabase
    try {
      const { data, error } = await supabase
        .from('verification_tokens')
        .select('*')
        .eq('token', token)
        .eq('email', email.toLowerCase())
        .single();

      if (!error && data) {
        console.log('Token found in Supabase database');
        
        // Check if token has expired
        const expiresAt = new Date(data.expires_at);
        if (expiresAt < new Date()) {
          console.log('Token has expired');
          
          // Delete expired token
          await supabase
            .from('verification_tokens')
            .delete()
            .eq('token', token);
          
          return null;
        }

        console.log('Token validation successful from Supabase');
        return {
          source: 'supabase',
          userData: data.user_data || { userId: data.user_id || 'temp_user_' + Date.now() },
          ...data
        };
      }
    } catch (supabaseError) {
      console.log('Supabase validation failed, trying localStorage fallback:', supabaseError.message);
    }

    // Fallback to localStorage
    console.log('Attempting localStorage validation...');
    const localData = validateTokenFromLocalStorage(token, email);
    if (localData) {
      console.log('Token validation successful from localStorage');
      return {
        source: 'localStorage',
        userData: localData.userData || { userId: 'temp_user_' + Date.now() },
        ...localData
      };
    }

    console.log('Token validation failed from both sources');
    return null;
  }

  // Mark token as used
  async function markTokenAsUsed(token, source) {
    try {
      if (source === 'supabase') {
        // Delete from Supabase
        await supabase
          .from('verification_tokens')
          .delete()
          .eq('token', token);
        console.log('Token removed from Supabase');
      } else if (source === 'localStorage') {
        // Delete from localStorage
        localStorage.removeItem(`verification_${token}`);
        console.log('Token removed from localStorage');
      }
    } catch (error) {
      console.error('Error marking token as used:', error);
    }
  }

  // Update user verification status if possible
  async function updateUserVerificationStatus(email) {
    try {
      const { error } = await supabase
        .from('users')
        .update({ 
          email_verified: true,
          email_verified_at: new Date().toISOString()
        })
        .eq('email', email.toLowerCase());

      if (error) {
        console.log('Could not update user verification status in database:', error.message);
      } else {
        console.log('User verification status updated in database');
      }
    } catch (error) {
      console.log('Database update not available, verification cached locally only');
    }
  }

  async function handleVerification(token, email) {
    console.log('Starting verification process for:', email);
    
    // Check if user is already verified (cache check)
    if (isUserAlreadyVerified(email)) {
      console.log('User is already verified (cached), proceeding to dashboard');
      return { alreadyVerified: true };
    }

    // Validate token from either Supabase or localStorage
    const validationData = await validateVerificationToken(token, email);
    if (!validationData) {
      throw new Error('Invalid or expired verification token. Please request a new verification email.');
    }

    const userData = validationData.userData;

    // Mark token as used
    await markTokenAsUsed(token, validationData.source);

    // Try to update database, but don't fail if it doesn't work
    await updateUserVerificationStatus(email);

    // Cache verification status locally
    markUserVerified(email.toLowerCase(), userData);

    console.log('User successfully verified via', validationData.source);
    return { userData, newlyVerified: true };
  }

  async function main() {
    try {
      const p = params();

      if (!p.token || !p.email) {
        throw new Error('Missing verification parameters. Please use the verification link sent to your email.');
      }

      console.log('Processing verification for:', p.email);
      
      const result = await handleVerification(p.token, p.email.toLowerCase());
      
      hide('loading');
      show('ok');
      
      if (result.alreadyVerified) {
        $('ok').innerHTML = `
          <i class="fas fa-check-circle bigicon success"></i>
          <h1 class="title">Already verified!</h1>
          <p class="msg">Your account is already verified. Redirecting to dashboard...</p>
          <a class="btn btn-primary" href="/parent-dashboard.html"><i class="fas fa-tachometer-alt"></i> Go to dashboard</a>
        `;
      }
      
      // Redirect to dashboard
      setTimeout(() => { 
        window.location.href = '/parent-dashboard.html'; 
      }, 2000);
      
    } catch (err) {
      console.error('Verify error:', err);
      hide('loading'); 
      show('fail');
      const t = $('errText'); 
      if (t) {
        t.textContent = err.message || 'Verification failed. Please try again or request a new verification email.';
      }
    }
  }

  window.addEventListener('DOMContentLoaded', main);
</script>
</body>
</html>