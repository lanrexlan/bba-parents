<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/png" sizes="32x32" href="/Images/logo.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email Verification - Baobab Online Academy</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700;900&family=Open+Sans:wght@300;400;600;700&family=Kalam:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --baobab-brown:#8D4004;--canopy-green:#2E7D32;--sunset-gold:#F57C00;--trunk-gray:#5D4037;
      --earth-cream:#FFF8E1;--desert-orange:#FF5722;--white:#FFFFFF;--deep-charcoal:#263238;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Open Sans',sans-serif;color:var(--deep-charcoal);
      background:linear-gradient(135deg,var(--canopy-green),var(--baobab-brown));
      min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .card{background:var(--white);border-radius:24px;padding:40px;max-width:680px;width:100%;
      text-align:center;border:3px solid var(--sunset-gold);box-shadow:0 20px 50px rgba(0,0,0,.3)}
    .logo{display:inline-flex;align-items:center;gap:12px;margin-bottom:10px}
    .logo-icon{width:44px;height:44px;background:var(--canopy-green);color:#fff;border-radius:10px;display:grid;place-items:center}
    .logo-text{font-family:'Merriweather',serif;color:var(--baobab-brown);font-weight:700;font-size:22px}
    .title{font-family:'Merriweather',serif;color:var(--baobab-brown);font-size:26px;margin:8px 0 12px}
    .msg{color:var(--trunk-gray);line-height:1.7;margin-bottom:16px}
    .bigicon{font-size:3.4rem;margin-bottom:10px}
    .loading{color:var(--sunset-gold);animation:spin 1s linear infinite}
    .success{color:var(--canopy-green)}
    .pending{color:var(--sunset-gold)}
    .error{color:var(--desert-orange)}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hidden{display:none}
    .details{background:var(--earth-cream);border:2px solid rgba(245,124,0,.3);padding:16px;border-radius:14px;text-align:left;margin:14px 0}
    .details h4{color:var(--sunset-gold);margin-bottom:8px;font-family:'Merriweather',serif}
    .details ul{list-style:none}
    .details li{margin:8px 0;display:flex;gap:10px;align-items:center;color:var(--trunk-gray)}
    .btn{display:inline-flex;align-items:center;gap:10px;padding:12px 22px;border-radius:26px;
      font-weight:600;text-decoration:none;cursor:pointer;border:2px solid transparent;margin:6px;transition:.25s}
    .btn-primary{background:var(--baobab-brown);color:#fff;border-color:var(--baobab-brown)}
    .btn-primary:hover{filter:brightness(.92);transform:translateY(-2px)}
    .btn-outline{background:transparent;color:var(--baobab-brown);border-color:var(--baobab-brown)}
    .btn-outline:hover{background:var(--baobab-brown);color:#fff}
    .muted{opacity:.85;font-size:.95rem;margin-top:14px}
    @media (max-width:576px){.card{padding:24px}.title{font-size:22px}.bigicon{font-size:3rem}}
  </style>
</head>
<body>
  <div class="card">
    <div class="logo">
      <div class="logo-icon"><i class="fas fa-tree"></i></div>
      <div class="logo-text">Baobab Academy</div>
    </div>

    <!-- Loading -->
    <div id="loading">
      <i class="fas fa-spinner bigicon loading"></i>
      <h1 class="title">Verifying your email…</h1>
      <p class="msg">Please wait while we process your verification.</p>
    </div>

    <!-- Full success (Supabase confirmed) -->
    <div id="ok" class="hidden">
      <i class="fas fa-check-circle bigicon success"></i>
      <h1 class="title">Email verified!</h1>
      <p class="msg">Your account is active. Redirecting to your dashboard…</p>
      <a class="btn btn-primary" href="/parent-dashboard.html"><i class="fas fa-tachometer-alt"></i> Go to dashboard</a>
    </div>

    <!-- Pending: custom token verified; final step email sent -->
    <div id="pending" class="hidden">
      <i class="fas fa-envelope-open-text bigicon pending"></i>
      <h1 class="title">Almost done — check your inbox</h1>
      <p class="msg" id="pendingMsg">
        We’ve verified your link. For security, please click the final confirmation link we just sent to your email.
      </p>
      <div class="details">
        <h4><i class="fas fa-lightbulb"></i> Finish activation</h4>
        <ul>
          <li><i class="fas fa-envelope"></i> Open the latest email from Baobab Online Academy</li>
          <li><i class="fas fa-link"></i> Click the “Confirm email” link</li>
          <li><i class="fas fa-sign-in-alt"></i> You can then log in immediately</li>
        </ul>
      </div>
      <button id="resendBtn" class="btn btn-outline"><i class="fas fa-redo"></i> Resend confirmation</button>
      <a class="btn btn-outline" href="/"><i class="fas fa-home"></i> Return home</a>
    </div>

    <!-- Error -->
    <div id="fail" class="hidden">
      <i class="fas fa-exclamation-triangle bigicon error"></i>
      <h1 class="title">Verification failed</h1>
      <p class="msg" id="errText">The link seems invalid or expired.</p>
      <div class="details">
        <h4><i class="fas fa-tools"></i> Try this:</h4>
        <ul>
          <li><i class="fas fa-envelope"></i> Open the newest verification email</li>
          <li><i class="fas fa-link"></i> Click the link again from this device</li>
        </ul>
      </div>
      <a class="btn btn-outline" href="/"><i class="fas fa-home"></i> Return home</a>
    </div>

    <p class="muted">Need help? Email parents@baobabonlineacademy.com or call +234 (0) 816 501 1291</p>
  </div>

  <script>
    const SUPABASE_URL = 'https://vcxdkacxbjsgaoxbhsip.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZjeGRrYWN4YmpzZ2FveGJoc2lwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MDQ5ODMsImV4cCI6MjA2ODQ4MDk4M30.T9KhHWzHZWyaZvyeFXtBu8tPLY9JOn6_wCHcH8B46FU';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = id => document.getElementById(id);
    const show = id => $(id).classList.remove('hidden');
    const hide = id => $(id).classList.add('hidden');

    function params() {
      const s = new URLSearchParams(window.location.search);
      let h = new URLSearchParams();
      if (window.location.hash && window.location.hash.includes('?')) {
        h = new URLSearchParams(window.location.hash.split('?')[1]);
      }
      const get = k => s.get(k) || h.get(k);
      return {
        token_hash: get('token_hash'),
        type: get('type'),
        access_token: get('access_token'),
        refresh_token: get('refresh_token'),
        token: get('token'),
        email: get('email')
      };
    }

    async function handleSupabaseFlow(token_hash, type, access_token, refresh_token) {
      // Preferred: token_hash + type from Supabase email
      if (token_hash && type) {
        const { data, error } = await supabase.auth.verifyOtp({
          token_hash,
          type: (type === 'email' ? 'email' : 'signup')
        });
        if (error) throw new Error(`Email verification failed: ${error.message}`);
        return data?.user || data?.session?.user || null;
      }

      // Fallback: session tokens present (provider puts tokens in URL)
      if (access_token && refresh_token) {
        const { data, error } = await supabase.auth.setSession({ access_token, refresh_token });
        if (error) throw new Error(`Session error: ${error.message}`);
        return data?.user || data?.session?.user || null;
      }

      return null;
    }

    async function upsertProfileAndMark(email, userId, meta) {
      // Upsert parent profile as the authenticated user
      const { error: upsertErr } = await supabase
        .from('parent_profiles')
        .upsert({
          user_id: userId,
          email: (email || '').toLowerCase(),
          full_name: meta?.full_name || null,
          phone: meta?.phone || null,
          email_verified: true,
          verified_at: new Date().toISOString()
        }, { onConflict: 'user_id' });

      if (upsertErr) console.warn('parent_profiles upsert warning:', upsertErr?.message);

      // Also flip authorised_emails as a best-effort (not critical)
      const { error: aeErr } = await supabase
        .from('authorised_emails')
        .update({ is_used: true, used_at: new Date().toISOString() })
        .eq('email', (email || '').toLowerCase());
      if (aeErr) console.warn('authorised_emails update warning:', aeErr?.message);
    }

    async function handleCustomEmailJSToken(token, email) {
  const { data, error } = await supabase.rpc('verify_parent_email', {
    p_token: token,
    p_email: email
  });

  if (error) throw new Error(error.message || 'Verification RPC failed');
  if (!data?.ok) {
    const reason = data?.reason || 'unknown';
    throw new Error(`Custom token invalid (${reason}).`);
  }

  // SUCCESS - show success and redirect (no pending state)
  hide('loading'); 
  show('ok');
  setTimeout(() => { 
    window.location.href = '/parent-dashboard.html'; 
  }, 1800);
}

      

    async function main() {
      try {
        const p = params();

        // 1) Supabase flow (true account activation)
        const user = await handleSupabaseFlow(p.token_hash, p.type, p.access_token, p.refresh_token);
        if (user) {
          await upsertProfileAndMark(user.email, user.id, user.user_metadata);
          hide('loading'); show('ok');
          setTimeout(() => { window.location.href = '/parent-dashboard.html'; }, 1800);
          return;
        }

        // 2) Custom EmailJS token (verify DB state, then trigger official email)
        if (p.token && p.email) {
          await handleCustomEmailJSToken(p.token, p.email.toLowerCase());
          return;
        }

        // Neither path present
        throw new Error('Missing verification parameters. Please use the verification link sent to your email.');

      } catch (err) {
        console.error('Verify error:', err);
        hide('loading'); show('fail');
        const t = $('errText'); if (t) t.textContent = err.message || 'Verification failed. Please try again.';
      }
    }

    window.addEventListener('DOMContentLoaded', main);
  </script>
</body>
</html>