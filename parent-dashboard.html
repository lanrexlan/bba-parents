<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" sizes="32x32" href="/Images/logo.jpg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parent Dashboard - Baobab Online Academy</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700;900&family=Open+Sans:wght@300;400;600;700&family=Kalam:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --baobab-brown:#8D4004;
      --canopy-green:#2E7D32;
      --sunset-gold:#F57C00;
      --trunk-gray:#5D4037;
      --sky-blue:#1976D2;
      --earth-cream:#FFF8E1;
      --desert-orange:#FF5722;
      --sage-green:#689F38;
      --deep-charcoal:#263238;
      --white:#FFFFFF;
      --light-gray:#F8FAFC;
      --border-color:#E2E8F0;
      --text-light:#64748B;

      --fast:0.22s ease;
      --med:0.4s cubic-bezier(0.165,0.84,0.44,1);
      --slow:0.6s cubic-bezier(0.165,0.84,0.44,1);

      --shadow-1:0 1px 2px rgba(0,0,0,0.06);
      --shadow-2:0 6px 14px rgba(0,0,0,0.08);
      --shadow-3:0 12px 30px rgba(0,0,0,0.12);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:'Open Sans',sans-serif;color:var(--deep-charcoal);line-height:1.6;
      background:
        radial-gradient(900px 500px at -20% -10%, rgba(245,124,0,0.08), transparent 60%),
        radial-gradient(700px 450px at 120% 0%, rgba(46,125,50,0.08), transparent 60%),
        linear-gradient(135deg,#F5F7FB 0%,#EAEFF7 100%);
      min-height:100vh;overflow-x:hidden;padding-bottom:76px;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }

    /* App Header (web + mobile) */
    .app-header{
      position:sticky;top:0;z-index:1000;
      background:rgba(255,255,255,0.9);backdrop-filter:blur(14px);
      border-bottom:1px solid rgba(226,232,240,0.7);box-shadow:var(--shadow-1);
    }
    .appbar{
      max-width:1200px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;text-decoration:none;
    }
    .brand-badge{
      width:40px;height:40px;border-radius:12px;display:grid;place-items:center;color:#fff;font-size:18px;
      background:linear-gradient(135deg,var(--canopy-green),var(--sage-green));box-shadow:var(--shadow-2);
    }
    .brand-title{
      font-family:'Merriweather',serif;font-weight:900;font-size:18px;letter-spacing:0.2px;
      background:linear-gradient(135deg,var(--baobab-brown),var(--sunset-gold));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
    }
    .app-actions{display:flex;align-items:center;gap:8px}
    .icon-btn{
      width:40px;height:40px;border:1px solid var(--border-color);border-radius:12px;background:#fff;color:var(--deep-charcoal);
      display:grid;place-items:center;box-shadow:var(--shadow-1);cursor:pointer;transition:transform var(--fast),box-shadow var(--fast),color var(--fast),background var(--fast);
    }
    .icon-btn:hover{transform:translateY(-1px);box-shadow:var(--shadow-2);background:var(--earth-cream);color:var(--sunset-gold)}
    .notif-badge{position:absolute;top:-4px;right:-4px;background:linear-gradient(135deg,var(--desert-orange),#FF6B35);color:#fff;border-radius:999px;font-size:10px;line-height:1;padding:4px 6px;border:2px solid #fff;font-weight:800}
    .user-pod{
      display:flex;align-items:center;gap:10px;padding:6px 10px;border:1px solid var(--border-color);border-radius:14px;background:#fff;box-shadow:var(--shadow-1);cursor:pointer;
      transition:transform var(--fast),box-shadow var(--fast),background var(--fast);
    }
    .user-pod:hover{transform:translateY(-1px);box-shadow:var(--shadow-2);background:var(--earth-cream)}
    .avatar{
      width:34px;height:34px;border-radius:10px;display:grid;place-items:center;color:#fff;font-weight:800;font-size:13px;
      background:linear-gradient(135deg,var(--sunset-gold),var(--desert-orange));
    }
    .user-meta{display:flex;flex-direction:column}
    .user-meta h4{font-size:13px;font-weight:800}
    .user-meta small{font-size:11px;color:var(--text-light)}

    /* Search (desktop) */
    .search-wrap{flex:1;display:flex;align-items:center;gap:8px;max-width:520px;margin:0 10px}
    .search{flex:1;display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--border-color);border-radius:12px;padding:8px 10px;box-shadow:var(--shadow-1)}
    .search i{color:var(--text-light)}
    .search input{width:100%;border:none;outline:none;font-size:14px;background:transparent}

    /* Layout */
    .container{
      max-width:1200px;margin:0 auto;padding:18px 16px 0;display:grid;grid-template-columns:280px 1fr;gap:18px;
    }

    /* Sidebar */
    .sidebar{
      position:sticky;top:76px;height:max-content;background:rgba(255,255,255,0.92);backdrop-filter:blur(14px);
      border:1px solid rgba(226,232,240,0.8);border-radius:16px;box-shadow:var(--shadow-2);padding:14px;z-index:1000;
    }
    .nav-list{list-style:none;display:flex;flex-direction:column;gap:6px}
    .nav-link{
      display:flex;align-items:center;gap:10px;padding:12px;border-radius:12px;color:var(--deep-charcoal);text-decoration:none;font-weight:700;font-size:14px;
      transition:background var(--fast),transform var(--fast),box-shadow var(--fast);
    }
    .nav-link i{width:20px;text-align:center;color:var(--text-light)}
    .nav-link:hover{background:rgba(248,250,252,0.8);transform:translateX(2px)}
    .nav-link.active{background:linear-gradient(135deg,rgba(46,125,50,0.12),rgba(245,124,0,0.12));box-shadow:var(--shadow-1)}

    /* Welcome banner */
    .banner{
      background:linear-gradient(135deg,#1f7a38 0%,#8D4004 100%);color:#fff;border-radius:16px;padding:22px;position:relative;overflow:hidden;box-shadow:var(--shadow-3);
    }
    .banner::before{
      content:'';position:absolute;inset:-60% -60% auto auto;width:200%;height:200%;
      background:linear-gradient(45deg,transparent,rgba(255,255,255,0.14),transparent);animation:shine 6s infinite;
    }
    @keyframes shine{0%{transform:translate(-100%,-100%) rotate(45deg)}100%{transform:translate(100%,100%) rotate(45deg)}}
    .banner h1{font-family:'Merriweather',serif;font-size:1.6rem;margin-bottom:6px;font-weight:900}
    .banner p{font-size:0.95rem;opacity:.95}
    .stats{display:grid;grid-template-columns:repeat(4,minmax(120px,1fr));gap:10px;margin-top:12px}
    .stat{
      background:rgba(255,255,255,0.18);backdrop-filter:blur(14px);border:1px solid rgba(255,255,255,0.25);
      border-radius:12px;padding:14px;text-align:center;transition:transform var(--fast),background var(--fast);
    }
    .stat:hover{transform:translateY(-3px);background:rgba(255,255,255,0.24)}
    .stat .num{font-weight:900;font-size:1.4rem;color:var(--earth-cream)}
    .stat .lbl{font-weight:700;font-size:0.9rem}

    /* Section shell */
    .section{display:none}
    .section.active{display:block}
    .panel{
      background:rgba(255,255,255,0.96);backdrop-filter:blur(14px);
      border:1px solid rgba(226,232,240,0.8);border-radius:16px;box-shadow:var(--shadow-2);padding:16px;margin-top:14px;
    }
    .panel-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .panel-title{
      display:flex;align-items:center;gap:10px;font-weight:900;font-size:1.05rem;
    }
    .panel-title .icon{
      width:42px;height:42px;border-radius:12px;display:grid;place-items:center;color:#fff;box-shadow:var(--shadow-1);
    }
    .tools{display:flex;align-items:center;gap:8px;flex-wrap:wrap}

    .btn{
      display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid var(--border-color);
      background:#fff;color:var(--deep-charcoal);cursor:pointer;font-weight:800;font-size:13px;box-shadow:var(--shadow-1);text-decoration:none;
      transition:transform var(--fast),box-shadow var(--fast),background var(--fast),color var(--fast);
    }
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow-2);background:var(--earth-cream)}
    .btn-primary{background:linear-gradient(135deg,var(--baobab-brown),var(--trunk-gray));color:#fff;border:none}
    .btn-primary:hover{background:linear-gradient(135deg,#7b3603,#4a2f29)}
    .btn-success{background:linear-gradient(135deg,var(--canopy-green),var(--sage-green));color:#fff;border:none}
    .btn-warning{background:linear-gradient(135deg,var(--sunset-gold),var(--desert-orange));color:#fff;border:none}

    /* Search + Export toolbar */
    .toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .input{
      height:40px;display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--border-color);border-radius:12px;padding:0 12px;box-shadow:var(--shadow-1);
    }
    .input input{border:none;outline:none;font-size:14px;background:transparent;min-width:220px}
    .badge{
      display:inline-flex;align-items:center;justify-content:center;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:800;
    }
    .badge.success{background:rgba(46,125,50,0.1);color:var(--canopy-green)}
    .badge.warn{background:rgba(245,124,0,0.12);color:var(--sunset-gold)}
    .badge.muted{background:rgba(38,50,56,0.08);color:var(--deep-charcoal)}
    .badge.danger{background:rgba(255,87,34,0.12);color:var(--desert-orange)}

    /* Data table */
    .table-wrap{width:100%;overflow:auto;border-radius:12px;border:1px solid var(--border-color)}
    table.data-table{width:100%;border-collapse:separate;border-spacing:0;background:#fff}
    .data-table thead th{
      position:sticky;top:0;background:#F8FAFE;border-bottom:1px solid var(--border-color);text-align:left;font-size:12px;letter-spacing:.3px;color:var(--text-light);
      padding:10px 12px;font-weight:900;z-index:1;
    }
    .data-table tbody td{border-bottom:1px solid var(--border-color);padding:12px;font-size:14px}
    .data-table tbody tr:hover{background:#FBFDF7}
    .cell-actions{display:flex;gap:6px;flex-wrap:wrap}
    .muted{color:var(--text-light)}

    /* Responsive stacked table on small screens */
    @media (max-width: 720px){
      .table-wrap{border:none}
      .data-table thead{display:none}
      .data-table, .data-table tbody, .data-table tr, .data-table td{display:block;width:100%}
      .data-table tr{background:#fff;border:1px solid var(--border-color);border-radius:12px;margin-bottom:10px;box-shadow:var(--shadow-1)}
      .data-table td{
        border-bottom:1px dashed var(--border-color);padding:10px 12px;display:flex;justify-content:space-between;gap:12px;
      }
      .data-table td:last-child{border-bottom:none}
      .data-table td::before{
        content:attr(data-label);font-weight:800;color:var(--text-light);flex:0 0 50%;
      }
    }

    /* Empty and Loading */
    .empty{
      text-align:center;padding:30px 18px;border:1px dashed var(--border-color);border-radius:12px;background:#fff;color:var(--text-light)
    }
    .loading{display:flex;align-items:center;justify-content:center;gap:10px;padding:28px;color:var(--text-light)}
    .spinner{width:36px;height:36px;border:3px solid var(--border-color);border-top:3px solid var(--sunset-gold);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.55);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:1200}
    .modal.active{display:flex}
    .modal-card{
      width:min(96vw,560px);max-height:90vh;overflow:auto;background:#fff;border-radius:16px;border:1px solid var(--border-color);
      box-shadow:var(--shadow-3);padding:18px;position:relative;
    }
    .modal-close{position:absolute;top:10px;right:12px;background:none;border:none;color:var(--text-light);font-size:20px;cursor:pointer}
    .form-group{margin-bottom:12px}
    .label{display:block;font-weight:800;margin-bottom:6px}
    .field{width:100%;height:44px;border:1.5px solid var(--border-color);border-radius:12px;padding:0 12px;font-size:14px}
    .field:focus{outline:none;border-color:var(--sunset-gold);box-shadow:0 0 0 3px rgba(245,124,0,0.12)}
    textarea.field{height:auto;padding:10px 12px;min-height:90px}

    /* Footer (redesigned) */
    .site-footer{
      margin-top:36px;background:radial-gradient(800px 300px at 20% 0%, rgba(245,124,0,0.12), transparent 50%), linear-gradient(180deg,#111827,#0F172A);
      color:#E5E7EB;padding:28px 0 22px;box-shadow:0 -6px 24px rgba(0,0,0,0.2);
    }
    .footer-inner{max-width:1200px;margin:0 auto;padding:0 16px}
    .footer-top{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;margin-bottom:16px;
    }
    .footer-brand{
      display:flex;align-items:center;gap:10px;font-weight:900
    }
    .footer-brand .badge{
      width:36px;height:36px;display:grid;place-items:center;border-radius:10px;color:#fff;background:linear-gradient(135deg,var(--canopy-green),var(--sage-green))
    }
    .footer-col h4{color:#FBBF24;margin-bottom:8px;font-size:1rem}
    .footer-link{color:#CBD5E1;text-decoration:none;display:inline-flex;align-items:center;gap:8px;padding:6px 0}
    .footer-link:hover{color:#FBBF24}
    .footer-bottom{
      border-top:1px solid rgba(148,163,184,0.2);padding-top:12px;color:#9CA3AF;text-align:center;font-size:13px
    }

    /* Bottom navigation (mobile) */
    .bottom-nav{
      position:fixed;left:0;right:0;bottom:0;z-index:1100;display:none;
      background:rgba(255,255,255,0.96);backdrop-filter:blur(14px);border-top:1px solid var(--border-color);
    }
    .bottom-nav-inner{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:repeat(5,1fr)}
    .tab-btn{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 2px;color:var(--text-light);text-decoration:none;font-weight:800;font-size:11px}
    .tab-btn i{font-size:18px}
    .tab-btn.active{color:var(--canopy-green)}

    /* Mobile adjustments */
    .menu-toggle{display:none}
    @media (max-width: 992px){
      .container{grid-template-columns:1fr;gap:14px}
      .sidebar{
        position:fixed;left:-310px;top:0;height:100vh;width:280px;padding:82px 14px 14px;border-radius:0;transition:left var(--med);z-index:1100
      }
      .sidebar.active{left:0}
      .menu-toggle{display:block}
      .search-wrap{display:none}
      .stats{grid-template-columns:repeat(2,1fr)}
      .bottom-nav{display:block}
    }
    @media (max-width: 560px){
      .stats{grid-template-columns:1fr}
      .banner h1{font-size:1.3rem}
      .brand-title{font-size:16px}
      .avatar{width:30px;height:30px;font-size:12px}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="app-header" role="banner">
    <div class="appbar">
      <div style="display:flex;align-items:center;gap:8px">
        <button class="icon-btn menu-toggle" id="menuToggle" aria-label="Open menu">
          <i class="fas fa-bars"></i>
        </button>
        <a class="brand" href="#">
          <div class="brand-badge" aria-hidden="true"><i class="fas fa-tree"></i></div>
          <div class="brand-title">Baobab Parent Portal</div>
        </a>
      </div>

      <div class="search-wrap" role="search">
        <div class="search">
          <i class="fas fa-search"></i>
          <input id="globalSearch" type="search" placeholder="Search children, lessons, reports..." />
        </div>
      </div>

      <div class="app-actions">
        <div style="position:relative">
          <button class="icon-btn" id="notifBtn" aria-label="Notifications"><i class="fas fa-bell"></i></button>
          <span class="notif-badge" id="notificationCount" style="display:none">0</span>
        </div>
        <div class="user-pod" id="userMenu" role="button" aria-label="User menu">
          <div class="avatar" id="userAvatar">P</div>
          <div class="user-meta">
            <h4 id="userName">Loading...</h4>
            <small>Parent</small>
          </div>
          <i class="fas fa-chevron-down" style="color:var(--text-light)"></i>
        </div>
      </div>
    </div>
  </header>

  <!-- Sidebar overlay -->
  <div id="sidebarOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.45);backdrop-filter:blur(4px);display:none;z-index:1090"></div>

  <!-- Main Layout -->
  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar" aria-label="Sidebar">
      <ul class="nav-list">
        <li><a class="nav-link active" href="#overview" data-section="overview"><i class="fas fa-home"></i>Dashboard Overview</a></li>
        <li><a class="nav-link" href="#children" data-section="children"><i class="fas fa-child"></i>Children Management</a></li>
        <li><a class="nav-link" href="#lessons" data-section="lessons"><i class="fas fa-calendar-alt"></i>Upcoming Lessons</a></li>
        <li><a class="nav-link" href="#tutors" data-section="tutors"><i class="fas fa-chalkboard-teacher"></i>Tutor Communication</a></li>
        <li><a class="nav-link" href="#recordings" data-section="recordings"><i class="fas fa-video"></i>Lesson Recordings</a></li>
        <li><a class="nav-link" href="#reports" data-section="reports"><i class="fas fa-file-alt"></i>Reports & Assessments</a></li>
        <li><a class="nav-link" href="#billing" data-section="billing"><i class="fas fa-credit-card"></i>Billing & Payments</a></li>
        <li><a class="nav-link" href="#profile" data-section="profile"><i class="fas fa-user-edit"></i>My Profile</a></li>
        <li><a class="nav-link" href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i>Logout</a></li>
      </ul>
    </aside>

    <!-- Content -->
    <main>
      <!-- Overview -->
      <section id="overview" class="section active" aria-label="Overview">
        <div class="banner">
          <h1>Welcome back, <span id="parentName">Parent</span>! ðŸ‘‹</h1>
          <p>Your child is making amazing progress. Hereâ€™s a quick snapshot of today.</p>
          <div class="stats">
            <div class="stat">
              <div class="num" id="totalLessons">0</div>
              <div class="lbl">Lessons Completed</div>
            </div>
            <div class="stat">
              <div class="num" id="averageGrade">0%</div>
              <div class="lbl">Average Grade</div>
            </div>
            <div class="stat">
              <div class="num" id="culturalMilestones">0</div>
              <div class="lbl">Cultural Milestones</div>
            </div>
            <div class="stat">
              <div class="num" id="activeTutors">0</div>
              <div class="lbl">Active Tutors</div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-head">
            <div class="panel-title">
              <div class="icon" style="background:linear-gradient(135deg,var(--canopy-green),var(--sage-green))"><i class="fas fa-chart-line"></i></div>
              Recent Progress
            </div>
            <div class="tools">
              <a class="btn" href="#reports" data-section="reports"><i class="fas fa-arrow-right"></i> View full reports</a>
            </div>
          </div>
          <div id="overviewProgress">
            <div class="loading"><div class="spinner"></div>Loading progress...</div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-head">
            <div class="panel-title">
              <div class="icon" style="background:linear-gradient(135deg,var(--sunset-gold),var(--desert-orange))"><i class="fas fa-calendar-alt"></i></div>
              Upcoming Lessons
            </div>
          </div>
          <div id="overviewLessons">
            <div class="loading"><div class="spinner"></div>Loading lessons...</div>
          </div>
        </div>
      </section>

      <!-- Children -->
      <section id="children" class="section" aria-label="Children Management">
        <div class="panel">
          <div class="panel-head">
            <div class="panel-title">
              <div class="icon" style="background:linear-gradient(135deg,var(--sky-blue),#4FC3F7)"><i class="fas fa-children"></i></div>
              Children
            </div>
            <div class="toolbar">
              <div class="input"><i class="fas fa-search"></i><input id="childrenSearch" type="search" placeholder="Search children..." /></div>
              <button class="btn" id="childrenExport"><i class="fas fa-file-export"></i>Export CSV</button>
            </div>
          </div>
          <div id="childrenTableWrap" class="table-wrap">
            <table class="data-table" id="childrenTable">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>DOB</th>
                  <th>Age</th>
                  <th>Grade</th>
                  <th>Status</th>
                  <th>Enrolled</th>
                  <th>Emergency Contact</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="childrenTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Lessons -->
      <section id="lessons" class="section" aria-label="Lessons">
        <div class="panel">
          <div class="panel-head">
            <div class="panel-title">
              <div class="icon" style="background:linear-gradient(135deg,var(--sunset-gold),var(--desert-orange))"><i class="fas fa-calendar-days"></i></div>
              Lessons
            </div>
            <div class="toolbar">
              <div class="input"><i class="fas fa-search"></i><input id="lessonsSearch" type="search" placeholder="Search lessons..." /></div>
              <button class="btn" id="lessonsExport"><i class="fas fa-file-export"></i>Export CSV</button>
            </div>
          </div>
          <div id="lessonsTableWrap" class="table-wrap">
            <table class="data-table" id="lessonsTable">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Child</th>
                  <th>Subject</th>
                  <th>Tutor</th>
                  <th>Status</th>
                  <th>Join</th>
                </tr>
              </thead>
              <tbody id="lessonsTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Tutors -->
      <section id="tutors" class="section" aria-label="Tutors">
        <div class="panel">
          <div class="panel-head">
            <div class="panel-title">
              <div class="icon" style="background:linear-gradient(135deg,var(--canopy-green),var(--sage-green))"><i class="fas fa-user-tie"></i></div>
              Assigned Tutors
            </div>
            <div class="toolbar">
              <div class="input"><i class="fas fa-search"></i><input id="tutorsSearch" type="search" placeholder="Search tutors..." /></div>
              <button class="btn" id="tutorsExport"><i class="fas fa-file-export"></i>Export CSV</button>
            </div>
          </div>
          <div id="tutorsTableWrap" class="table-wrap">
            <table class="data-table" id="tutorsTable">
              <thead>
                <tr>
                  <th>Tutor</th>
                  <th>Child</th>
                  <th>Subject</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="tutorsTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Recordings -->
      <section id="recordings" class="section" aria-label="Lesson Recordings">
        <div class="panel">
          <div class="panel-head">
            <div class="panel-title">
              <div class="icon" style="background:linear-gradient(135deg,#6D28D9,#9333EA)"><i class="fas fa-video"></i></div>
              Lesson Recordings
            </div>
            <div class="toolbar">
              <div class="input"><i class="fas fa-search"></i><input id="recordingsSearch" type="search" placeholder="Search recordings..." /></div>
              <button class="btn" id="recordingsExport"><i class="fas fa-file-export"></i>Export CSV</button>
            </div>
          </div>
          <div id="recordingsTableWrap" class="table-wrap">
            <table class="data-table" id="recordingsTable">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Child</th>
                  <th>Subject</th>
                  <th>Duration</th>
                  <th>Recording</th>
                </tr>
              </thead>
              <tbody id="recordingsTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Reports & Assessments -->
      <section id="reports" class="section" aria-label="Reports">
        <div class="panel">
          <div class="panel-head">
            <div class="panel-title">
              <div class="icon" style="background:linear-gradient(135deg,var(--sky-blue),#4FC3F7)"><i class="fas fa-chart-bar"></i></div>
              Reports & Assessments
            </div>
            <div class="tools">
              <button class="btn" id="refreshReports"><i class="fas fa-rotate"></i>Refresh</button>
            </div>
          </div>

          <div class="panel" style="margin-top:8px">
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
              <button class="btn btn-success" data-tab="tab-assessments">Assessments</button>
              <button class="btn" data-tab="tab-progress">Progress Records</button>
            </div>

            <div id="tab-assessments" class="tab-pane">
              <div class="panel-head" style="padding:0;margin-bottom:10px">
                <div class="toolbar">
                  <div class="input"><i class="fas fa-search"></i><input id="assessmentsSearch" type="search" placeholder="Search assessments..." /></div>
                  <button class="btn" id="assessmentsExport"><i class="fas fa-file-export"></i>Export CSV</button>
                </div>
              </div>
              <div class="panel" style="margin-top:8px">
                <div style="display:grid;grid-template-columns:1fr;gap:16px">
                  <div style="min-height:220px">
                    <canvas id="avgBySubjectChart" height="160"></canvas>
                  </div>
                  <div style="min-height:220px">
                    <canvas id="trendChart" height="160"></canvas>
                  </div>
                </div>
              </div>
              <div class="panel" style="margin-top:12px">
                <div class="table-wrap">
                  <table class="data-table" id="assessmentsTable">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Child</th>
                        <th>Subject</th>
                        <th>Title</th>
                        <th>Type</th>
                        <th>Score</th>
                        <th>Feedback</th>
                      </tr>
                    </thead>
                    <tbody id="assessmentsTbody"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div id="tab-progress" class="tab-pane" style="display:none">
              <div class="panel-head" style="padding:0;margin-bottom:10px">
                <div class="toolbar">
                  <div class="input"><i class="fas fa-search"></i><input id="progressSearch" type="search" placeholder="Search progress records..." /></div>
                  <button class="btn" id="progressExport"><i class="fas fa-file-export"></i>Export CSV</button>
                </div>
              </div>
              <div class="panel">
                <div class="table-wrap">
                  <table class="data-table" id="progressTable">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Child</th>
                        <th>Subject</th>
                        <th>Score</th>
                        <th>Strengths</th>
                        <th>Improvement</th>
                        <th>Recorded By</th>
                      </tr>
                    </thead>
                    <tbody id="progressTbody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- Billing -->
      <section id="billing" class="section" aria-label="Billing">
        <div class="panel">
          <div class="panel-head">
            <div class="panel-title">
              <div class="icon" style="background:linear-gradient(135deg,var(--baobab-brown),var(--trunk-gray))"><i class="fas fa-file-invoice-dollar"></i></div>
              Billing & Payments
            </div>
            <div class="toolbar">
              <div class="input"><i class="fas fa-search"></i><input id="billingSearch" type="search" placeholder="Search billing..." /></div>
              <button class="btn" id="billingExport"><i class="fas fa-file-export"></i>Export CSV</button>
            </div>
          </div>
          <div class="table-wrap">
            <table class="data-table" id="billingTable">
              <thead>
                <tr>
                  <th>Created</th>
                  <th>Description</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Due</th>
                  <th>Paid At</th>
                  <th>Method</th>
                  <th>Txn ID</th>
                </tr>
              </thead>
              <tbody id="billingTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Profile -->
      <section id="profile" class="section" aria-label="Profile">
        <div class="panel">
          <div class="panel-head">
            <div class="panel-title">
              <div class="icon" style="background:linear-gradient(135deg,var(--baobab-brown),var(--trunk-gray))"><i class="fas fa-user-cog"></i></div>
              My Profile
            </div>
          </div>
          <div class="panel">
            <form id="profileForm">
              <div class="form-group">
                <label class="label" for="profileFullName">Full Name</label>
                <input class="field" id="profileFullName" name="full_name" type="text" placeholder="Enter your full name" />
              </div>
              <div class="form-group">
                <label class="label" for="profileEmail">Email</label>
                <input class="field" id="profileEmail" type="email" readonly />
              </div>
              <div class="form-group">
                <label class="label" for="profilePhone">Phone</label>
                <input class="field" id="profilePhone" name="phone" type="tel" placeholder="Enter your phone number" />
              </div>
              <div class="form-group">
                <label class="label" for="profileAddress">Address</label>
                <input class="field" id="profileAddress" name="address" type="text" placeholder="Enter your address" />
              </div>
              <button class="btn btn-primary" type="submit"><i class="fas fa-save"></i> Update Profile</button>
            </form>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Bottom Nav (mobile) -->
  <nav class="bottom-nav" aria-label="Bottom navigation">
    <div class="bottom-nav-inner">
      <a href="#overview" class="tab-btn active" data-section="overview"><i class="fas fa-home"></i><span>Home</span></a>
      <a href="#children" class="tab-btn" data-section="children"><i class="fas fa-child"></i><span>Children</span></a>
      <a href="#lessons" class="tab-btn" data-section="lessons"><i class="fas fa-calendar-alt"></i><span>Lessons</span></a>
      <a href="#reports" class="tab-btn" data-section="reports"><i class="fas fa-file-alt"></i><span>Reports</span></a>
      <a href="#profile" class="tab-btn" data-section="profile"><i class="fas fa-user"></i><span>Profile</span></a>
    </div>
  </nav>

  <!-- Child Edit Modal -->
  <div class="modal" id="childEditModal" role="dialog" aria-labelledby="childEditTitle" aria-modal="true">
    <div class="modal-card">
      <button class="modal-close" onclick="closeChildEditModal()" aria-label="Close"><i class="fas fa-times"></i></button>
      <h3 id="childEditTitle" style="font-weight:900;font-size:1.1rem;margin-bottom:10px">Edit Child Information</h3>
      <form id="childEditForm">
        <input type="hidden" id="editChildId" />
        <div class="form-group">
          <label class="label" for="editChildName">Full Name</label>
          <input class="field" id="editChildName" name="name" type="text" required />
        </div>
        <div class="form-group">
          <label class="label" for="editChildDOB">Date of Birth</label>
          <input class="field" id="editChildDOB" name="date_of_birth" type="date" />
        </div>
        <div class="form-group">
          <label class="label" for="editChildGrade">Grade Level</label>
          <input class="field" id="editChildGrade" name="grade_level" type="text" />
        </div>
        <div class="form-group">
          <label class="label" for="editChildEmergency">Emergency Contact</label>
          <input class="field" id="editChildEmergency" name="emergency_contact" type="text" />
        </div>
        <div class="form-group">
          <label class="label" for="editChildMedical">Medical Information</label>
          <textarea class="field" id="editChildMedical" name="medical_info"></textarea>
        </div>
        <div class="form-group">
          <label class="label" for="editChildPreferences">Learning Preferences</label>
          <textarea class="field" id="editChildPreferences" name="learning_preferences"></textarea>
        </div>
        <button class="btn btn-primary" type="submit"><i class="fas fa-save"></i> Update</button>
      </form>
    </div>
  </div>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-inner">
      <div class="footer-top">
        <div>
          <div class="footer-brand">
            <div class="badge"><i class="fas fa-tree"></i></div>
            <div>Baobab Online Academy</div>
          </div>
          <p style="margin-top:8px;color:#CBD5E1">Nurturing Growth, Honoring Heritage. A modern learning experience for every family.</p>
        </div>
        <div class="footer-col">
          <h4>Links</h4>
          <a class="footer-link" href="/parent-portal.html"><i class="fas fa-link"></i> Parent Portal</a>
          <a class="footer-link" href="/"><i class="fas fa-globe"></i> Main Site</a>
        </div>
        <div class="footer-col">
          <h4>Support</h4>
          <a class="footer-link" href="mailto:parents@baobabacademy.com"><i class="fas fa-envelope"></i> parents@baobabacademy.com</a>
          <a class="footer-link" href="tel:+442012345678"><i class="fas fa-phone"></i> +44 (0) 20 1234 5678</a>
        </div>
      </div>
      <div class="footer-bottom">
        &copy; 2025 Baobab Online Academy. All rights reserved.
      </div>
    </div>
  </footer>

  <script>
    // Supabase setup
    const SUPABASE_URL = 'https://vcxdkacxbjsgaoxbhsip.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZjeGRrYWN4YmpzZ2FveGJoc2lwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MDQ5ODMsImV4cCI6MjA2ODQ4MDk4M30.T9KhHWzHZWyaZvyeFXtBu8tPLY9JOn6_wCHcH8B46FU';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // State
    let currentUser = null;
    let parentProfile = null;
    let children = [];
    let charts = { avgBySubject: null, trend: null };
    const cache = {
      children: [],
      lessons: [],
      tutors: [],
      recordings: [],
      assessments: [],
      progress: [],
      billing: []
    };

    // UI elements
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');

    function toggleSidebar(open) {
      const show = open ?? !sidebar.classList.contains('active');
      sidebar.classList.toggle('active', show);
      sidebarOverlay.style.display = show ? 'block' : 'none';
      document.body.style.overflow = show ? 'hidden' : 'auto';
      menuToggle.innerHTML = show ? '<i class="fas fa-times"></i>' : '<i class="fas fa-bars"></i>';
    }
    menuToggle?.addEventListener('click', () => toggleSidebar());
    sidebarOverlay?.addEventListener('click', () => toggleSidebar(false));

    // Hash routing
    function setActive(sectionId){
      document.querySelectorAll('.section').forEach(s => s.classList.toggle('active', s.id === sectionId));
      document.querySelectorAll('.nav-link').forEach(a => a.classList.toggle('active', a.dataset.section === sectionId));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.section === sectionId));
      loadSection(sectionId);
      toggleSidebar(false);
    }
    function routeFromHash(){
      const id = (location.hash || '#overview').replace('#','');
      setActive(id);
    }
    window.addEventListener('hashchange', routeFromHash);

    // Helpers
    function initialsOf(str){
      if(!str) return 'P';
      const base = str.includes('@') ? str.split('@')[0] : str;
      const parts = base.trim().split(/\s+/).filter(Boolean);
      return (parts[0]?.[0] || base[0] || 'P').toUpperCase() + (parts[1]?.[0] || '').toUpperCase();
    }
    function fmtDate(d){ if(!d) return ''; const dt = new Date(d); return dt.toLocaleDateString(); }
    function fmtTime(d){ if(!d) return ''; const dt = new Date(d); return dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
    function yearsFrom(d){
      if(!d) return '';
      const ms = Date.now() - new Date(d).getTime();
      return Math.floor(ms / (365.25*24*60*60*1000));
    }
    function toPercent(grade,max){ if(!grade && grade!==0) return ''; const denom = max || 100; const pct = Math.round((Number(grade)/Number(denom))*100); return pct + '%'; }
    function statusBadge(status){
      const s = (status||'').toLowerCase();
      const cls = s.includes('paid')||s.includes('active') ? 'success' : s.includes('pending')||s.includes('scheduled') ? 'warn' : s.includes('failed')||s.includes('overdue') ? 'danger' : 'muted';
      return `<span class="badge ${cls}">${status || 'â€”'}</span>`;
    }
    function escapeCSV(val){
      if(val == null) return '';
      const s = String(val);
      return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
    }
    function exportCSV(filename, rows, columns){
      const header = columns.map(c => c.label).join(',');
      const body = rows.map(r => columns.map(c => escapeCSV(c.get ? c.get(r) : r[c.key])).join(',')).join('\n');
      const csv = header + '\n' + body;
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    // Auth
    async function ensureAuth(){
      const { data: { session } } = await supabase.auth.getSession();
      if(!session){ location.href='/parent-portal.html'; return null; }
      if(!session.user.email_confirmed_at){ alert('Please verify your email.'); location.href='/parent-portal.html'; return null; }
      currentUser = session.user;
      return currentUser;
    }

    async function loadProfile(){
      const { data: profile } = await supabase.from('parent_profiles').select('*').eq('user_id', currentUser.id).maybeSingle();
      if(!profile){
        const fallback = {
          user_id: currentUser.id,
          full_name: currentUser.user_metadata?.full_name || '',
          email: currentUser.email,
          phone: currentUser.user_metadata?.phone || ''
        };
        const { data: created } = await supabase.from('parent_profiles').insert([fallback]).select().single();
        parentProfile = created || fallback;
      }else{
        parentProfile = profile;
      }
      const displayName = (parentProfile.full_name?.trim()) || (currentUser.user_metadata?.full_name?.trim()) || (currentUser.email?.split('@')[0]) || 'Parent';
      const firstName = displayName.split(' ')[0];
      document.getElementById('userName').textContent = displayName;
      document.getElementById('parentName').textContent = firstName;
      document.getElementById('userAvatar').textContent = initialsOf(parentProfile.full_name || currentUser.email);

      // form
      document.getElementById('profileFullName').value = parentProfile.full_name || '';
      document.getElementById('profileEmail').value = currentUser.email || '';
      document.getElementById('profilePhone').value = parentProfile.phone || '';
      document.getElementById('profileAddress').value = parentProfile.address || '';
    }

    async function loadChildren(){
      const { data, error } = await supabase.from('children').select('*').eq('parent_id', currentUser.id).order('created_at', { ascending: true });
      if(error){ console.error(error); children = []; return; }
      children = data || [];
      cache.children = children;
    }

    async function loadDashboardStats(){
      if(!children.length){
        document.getElementById('totalLessons').textContent = 0;
        document.getElementById('averageGrade').textContent = '0%';
        document.getElementById('culturalMilestones').textContent = 0;
        document.getElementById('activeTutors').textContent = 0;
        return;
      }
      const ids = children.map(c => c.id);

      const { data: lessons } = await supabase.from('lessons').select('id').in('child_id', ids).eq('status','completed');
      document.getElementById('totalLessons').textContent = lessons?.length || 0;

      const { data: grades } = await supabase.from('assessments').select('grade,max_grade').in('child_id', ids);
      if(grades?.length){
        const avg = grades.reduce((s,g)=> s + (Number(g.grade)/(Number(g.max_grade)||100))*100, 0) / grades.length;
        document.getElementById('averageGrade').textContent = Math.round(avg) + '%';
      }else{
        document.getElementById('averageGrade').textContent = '0%';
      }

      const { data: milestones } = await supabase.from('cultural_milestones').select('id').in('child_id', ids).eq('achieved', true);
      document.getElementById('culturalMilestones').textContent = milestones?.length || 0;

      const { data: tutors } = await supabase.from('tutor_assignments').select('tutor_id').in('child_id', ids).eq('status','active');
      const uniqueTutors = [...new Set((tutors||[]).map(t => t.tutor_id))];
      document.getElementById('activeTutors').textContent = uniqueTutors.length;
    }

    // Overview widgets
    async function loadOverviewCards(){
      const cids = children.map(c => c.id);
      // Recent progress (progress_records)
      const { data: recent } = await supabase
        .from('progress_records')
        .select('score, recorded_at, children:child_id(name), subjects:subject_id(name)')
        .in('child_id', cids)
        .order('recorded_at', { ascending:false })
        .limit(5);

      const progWrap = document.getElementById('overviewProgress');
      if(!recent?.length){
        progWrap.innerHTML = '<div class="empty">No progress records yet.</div>';
      }else{
        progWrap.innerHTML = recent.map(p => `
          <div style="display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border-color);border-radius:12px;padding:10px;margin-bottom:8px;background:#fff">
            <div style="min-width:0">
              <div style="font-weight:900">${p.subjects?.name || 'Subject'}</div>
              <div class="muted" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.children?.name || 'Child'} â€¢ ${fmtDate(p.recorded_at)}</div>
            </div>
            <div style="display:flex;align-items:center;gap:10px">
              <div style="width:120px;height:10px;background:var(--border-color);border-radius:999px;overflow:hidden">
                <div style="height:100%;width:${Number(p.score)||0}%;background:linear-gradient(90deg,var(--canopy-green),var(--sage-green))"></div>
              </div>
              <div class="badge success">${Number(p.score)||0}%</div>
            </div>
          </div>
        `).join('');
      }

      // Upcoming lessons
      const nowIso = new Date().toISOString();
      const { data: upcoming } = await supabase
        .from('lessons')
        .select('id, scheduled_at, status, meeting_url, children:child_id(name), tutors:tutor_id(full_name), subjects:subject_id(name)')
        .in('child_id', cids)
        .eq('status','scheduled')
        .gte('scheduled_at', nowIso)
        .order('scheduled_at', { ascending:true })
        .limit(5);

      const lessonsWrap = document.getElementById('overviewLessons');
      if(!upcoming?.length){
        lessonsWrap.innerHTML = '<div class="empty">No upcoming lessons scheduled.</div>';
      }else{
        lessonsWrap.innerHTML = upcoming.map(l => {
          const dt = new Date(l.scheduled_at);
          const isToday = dt.toDateString() === new Date().toDateString();
          return `
            <div style="display:flex;align-items:center;gap:10px;border:1px solid var(--border-color);border-radius:12px;padding:10px;margin-bottom:8px;background:#fff">
              <div class="badge warn" style="min-width:86px;justify-content:center">${isToday ? 'Today' : fmtDate(l.scheduled_at)} ${fmtTime(l.scheduled_at)}</div>
              <div style="flex:1;min-width:0">
                <div style="font-weight:900">${l.subjects?.name || 'Subject'}</div>
                <div class="muted" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">with ${l.tutors?.full_name || 'Tutor'} â€¢ ${l.children?.name || ''}</div>
              </div>
              ${isToday && l.meeting_url ? `<a class="btn btn-success" href="${l.meeting_url}" target="_blank" rel="noopener"><i class="fas fa-video"></i> Join</a>` : `<span class="badge muted">${l.status || 'Scheduled'}</span>`}
            </div>
          `;
        }).join('');
      }
    }

    // Tables: renderers
    function renderChildrenTable(rows){
      const tb = document.getElementById('childrenTbody');
      if(!rows?.length){ tb.innerHTML = `<tr><td data-label="Info" colspan="8"><div class="empty">No children found.</div></td></tr>`; return; }
      tb.innerHTML = rows.map(r => `
        <tr>
          <td data-label="Name">${r.name || ''}</td>
          <td data-label="DOB">${fmtDate(r.date_of_birth)}</td>
          <td data-label="Age">${yearsFrom(r.date_of_birth) || ''}</td>
          <td data-label="Grade">${r.grade_level || ''}</td>
          <td data-label="Status">${statusBadge(r.status || 'Active')}</td>
          <td data-label="Enrolled">${fmtDate(r.enrollment_date)}</td>
          <td data-label="Emergency Contact"><span class="muted">${r.emergency_contact || 'â€”'}</span></td>
          <td data-label="Actions">
            <div class="cell-actions">
              <button class="btn btn-warning" onclick="openChildEditModal('${r.id}')"><i class="fas fa-edit"></i> Edit</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function renderLessonsTable(rows){
      const tb = document.getElementById('lessonsTbody');
      if(!rows?.length){ tb.innerHTML = `<tr><td data-label="Info" colspan="7"><div class="empty">No lessons found.</div></td></tr>`; return; }
      tb.innerHTML = rows.map(r => `
        <tr>
          <td data-label="Date">${fmtDate(r.scheduled_at)}</td>
          <td data-label="Time">${fmtTime(r.scheduled_at)}</td>
          <td data-label="Child">${r.children?.name || ''}</td>
          <td data-label="Subject">${r.subjects?.name || ''}</td>
          <td data-label="Tutor">${r.tutors?.full_name || ''}</td>
          <td data-label="Status">${statusBadge(r.status)}</td>
          <td data-label="Join">
            ${r.meeting_url ? `<a class="btn btn-success" href="${r.meeting_url}" target="_blank" rel="noopener"><i class="fas fa-video"></i> Join</a>` : '<span class="muted">â€”</span>'}
          </td>
        </tr>
      `).join('');
    }

    function renderTutorsTable(rows){
      const tb = document.getElementById('tutorsTbody');
      if(!rows?.length){ tb.innerHTML = `<tr><td data-label="Info" colspan="4"><div class="empty">No tutor assignments found.</div></td></tr>`; return; }
      tb.innerHTML = rows.map(r => `
        <tr>
          <td data-label="Tutor">${r.tutors?.full_name || ''}</td>
          <td data-label="Child">${r.children?.name || ''}</td>
          <td data-label="Subject">${r.subjects?.name || ''}</td>
          <td data-label="Status">${statusBadge(r.status || 'Active')}</td>
        </tr>
      `).join('');
    }

    function renderRecordingsTable(rows){
      const tb = document.getElementById('recordingsTbody');
      if(!rows?.length){ tb.innerHTML = `<tr><td data-label="Info" colspan="5"><div class="empty">No recordings available.</div></td></tr>`; return; }
      tb.innerHTML = rows.map(r => `
        <tr>
          <td data-label="Date">${fmtDate(r.recorded_at)}</td>
          <td data-label="Child">${r.children?.name || ''}</td>
          <td data-label="Subject">${r.subjects?.name || ''}</td>
          <td data-label="Duration"><span class="muted">${r.duration || 'â€”'}</span></td>
          <td data-label="Recording">
            ${r.recording_url ? `<a class="btn btn-success" href="${r.recording_url}" target="_blank" rel="noopener"><i class="fas fa-play"></i> Watch</a>` : '<span class="muted">â€”</span>'}
          </td>
        </tr>
      `).join('');
    }

    function renderAssessmentsTable(rows){
      const tb = document.getElementById('assessmentsTbody');
      if(!rows?.length){ tb.innerHTML = `<tr><td data-label="Info" colspan="7"><div class="empty">No assessments recorded.</div></td></tr>`; return; }
      tb.innerHTML = rows.map(a => {
        const pct = toPercent(a.grade, a.max_grade);
        const scoreStr = (a.grade!=null ? a.grade : 'â€”') + (a.max_grade ? ` / ${a.max_grade}` : '') + (pct ? ` (${pct})` : '');
        return `
          <tr>
            <td data-label="Date">${fmtDate(a.conducted_at)}</td>
            <td data-label="Child">${a.children?.name || ''}</td>
            <td data-label="Subject">${a.subjects?.name || ''}</td>
            <td data-label="Title">${a.title || ''}</td>
            <td data-label="Type"><span class="badge muted">${a.type || 'quiz'}</span></td>
            <td data-label="Score">${scoreStr}</td>
            <td data-label="Feedback"><span class="muted">${a.feedback ? String(a.feedback).slice(0,80) : 'â€”'}</span></td>
          </tr>
        `;
      }).join('');
    }

    function renderProgressTable(rows){
      const tb = document.getElementById('progressTbody');
      if(!rows?.length){ tb.innerHTML = `<tr><td data-label="Info" colspan="7"><div class="empty">No progress records yet.</div></td></tr>`; return; }
      tb.innerHTML = rows.map(p => `
        <tr>
          <td data-label="Date">${fmtDate(p.recorded_at)}</td>
          <td data-label="Child">${p.children?.name || ''}</td>
          <td data-label="Subject">${p.subjects?.name || ''}</td>
          <td data-label="Score">${p.score!=null ? p.score + '%' : 'â€”'}</td>
          <td data-label="Strengths"><span class="muted">${p.strengths ? String(p.strengths).slice(0,60) : 'â€”'}</span></td>
          <td data-label="Improvement"><span class="muted">${p.areas_of_improvement ? String(p.areas_of_improvement).slice(0,60) : 'â€”'}</span></td>
          <td data-label="Recorded By"><span class="muted">${p.tutors?.full_name || 'â€”'}</span></td>
        </tr>
      `).join('');
    }

    function renderBillingTable(rows){
      const tb = document.getElementById('billingTbody');
      if(!rows?.length){ tb.innerHTML = `<tr><td data-label="Info" colspan="8"><div class="empty">No billing records yet.</div></td></tr>`; return; }
      tb.innerHTML = rows.map(b => `
        <tr>
          <td data-label="Created">${fmtDate(b.created_at)}</td>
          <td data-label="Description">${b.description || ''}</td>
          <td data-label="Amount">${b.currency || 'GBP'} ${Number(b.amount || 0).toFixed(2)}</td>
          <td data-label="Status">${statusBadge(b.status || 'pending')}</td>
          <td data-label="Due">${fmtDate(b.due_date)}</td>
          <td data-label="Paid At">${fmtDate(b.paid_at)}</td>
          <td data-label="Method"><span class="muted">${b.payment_method || 'â€”'}</span></td>
          <td data-label="Txn ID"><span class="muted">${b.transaction_id || 'â€”'}</span></td>
        </tr>
      `).join('');
    }

    // Loaders per section
    async function loadChildrenSection(){
      renderChildrenTable(cache.children);
    }

    async function loadLessonsSection(){
      if(!children.length){ renderLessonsTable([]); return; }
      const ids = children.map(c=>c.id);
      const { data, error } = await supabase
        .from('lessons')
        .select('id, scheduled_at, status, meeting_url, children:child_id(name), tutors:tutor_id(full_name), subjects:subject_id(name)')
        .in('child_id', ids)
        .order('scheduled_at', { ascending: true });
      if(error){ console.error(error); renderLessonsTable([]); return; }
      cache.lessons = data || [];
      renderLessonsTable(cache.lessons);
    }

    async function loadTutorsSection(){
      if(!children.length){ renderTutorsTable([]); return; }
      const ids = children.map(c=>c.id);
      const { data, error } = await supabase
        .from('tutor_assignments')
        .select('status, children:child_id(name), tutors:tutor_id(full_name,email), subjects:subject_id(name)')
        .in('child_id', ids)
        .order('created_at', { ascending: false });
      if(error){ console.error(error); renderTutorsTable([]); return; }
      cache.tutors = data || [];
      renderTutorsTable(cache.tutors);
    }

    async function loadRecordingsSection(){
      if(!children.length){ renderRecordingsTable([]); return; }
      const ids = children.map(c=>c.id);
      const { data, error } = await supabase
        .from('lesson_recordings')
        .select('recorded_at, duration, recording_url, children:child_id(name), subjects:subject_id(name)')
        .in('child_id', ids)
        .order('recorded_at', { ascending: false });
      if(error){ console.error(error); renderRecordingsTable([]); return; }
      cache.recordings = data || [];
      renderRecordingsTable(cache.recordings);
    }

    async function loadReportsSection(){
      if(!children.length){
        renderAssessmentsTable([]); renderProgressTable([]);
        if(charts.avgBySubject){ charts.avgBySubject.destroy(); charts.avgBySubject = null; }
        if(charts.trend){ charts.trend.destroy(); charts.trend = null; }
        return;
      }
      const ids = children.map(c=>c.id);
      // Assessments
      const { data: assessments } = await supabase
        .from('assessments')
        .select('id, grade, max_grade, title, type, feedback, conducted_at, children:child_id(name), subjects:subject_id(name)')
        .in('child_id', ids)
        .order('conducted_at', { ascending:false });
      cache.assessments = assessments || [];
      renderAssessmentsTable(cache.assessments);

      // Charts: averages by subject
      const bySubject = {};
      (cache.assessments).forEach(a=>{
        const s = a.subjects?.name || 'Subject';
        const pct = a.max_grade ? (Number(a.grade||0)/Number(a.max_grade))*100 : Number(a.grade||0);
        if(!bySubject[s]) bySubject[s] = {sum:0,count:0};
        bySubject[s].sum += pct; bySubject[s].count += 1;
      });
      const subjectAverages = Object.entries(bySubject).map(([subject,agg]) => ({ subject, avg: Math.round(agg.sum/agg.count) }));
      const ctx1 = document.getElementById('avgBySubjectChart').getContext('2d');
      if(charts.avgBySubject) charts.avgBySubject.destroy();
      charts.avgBySubject = new Chart(ctx1, {
        type:'bar',
        data:{ labels:subjectAverages.map(s=>s.subject), datasets:[{ data:subjectAverages.map(s=>s.avg), label:'Average %', backgroundColor:'rgba(46,125,50,.6)', borderColor:'rgba(46,125,50,1)', borderWidth:1.5, borderRadius:6 }] },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, max:100, ticks:{ callback:v=>v+'%'} } }, plugins:{ legend:{ display:false } } }
      });

      // Trend: last 12
      const last = (cache.assessments).slice(0,12).reverse();
      const trend = last.map(a => ({ label: fmtDate(a.conducted_at), value: Math.round((Number(a.grade||0) / (Number(a.max_grade)||100))*100) }));
      const ctx2 = document.getElementById('trendChart').getContext('2d');
      if(charts.trend) charts.trend.destroy();
      charts.trend = new Chart(ctx2, {
        type:'line',
        data:{ labels:trend.map(t=>t.label), datasets:[{ data:trend.map(t=>t.value), label:'Score %', borderColor:'rgba(245,124,0,1)', backgroundColor:'rgba(245,124,0,0.15)', tension:0.25, fill:true, pointRadius:3 }] },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, max:100, ticks:{ callback:v=>v+'%'} } }, plugins:{ legend:{ display:false } } }
      });

      // Progress records
      const { data: progress } = await supabase
        .from('progress_records')
        .select('score, strengths, areas_of_improvement, recorded_at, children:child_id(name), subjects:subject_id(name), tutors:recorded_by(full_name)')
        .in('child_id', ids)
        .order('recorded_at', { ascending:false });
      cache.progress = progress || [];
      renderProgressTable(cache.progress);
    }

    async function loadBillingSection(){
      const { data, error } = await supabase
        .from('billing_records')
        .select('*')
        .eq('parent_id', currentUser.id)
        .order('created_at', { ascending:false });
      if(error){ console.error(error); renderBillingTable([]); return; }
      cache.billing = data || [];
      renderBillingTable(cache.billing);
    }

    // Section dispatcher
    async function loadSection(id){
      switch(id){
        case 'overview':
          await loadDashboardStats();
          await loadOverviewCards();
          break;
        case 'children':
          await loadChildrenSection();
          break;
        case 'lessons':
          await loadLessonsSection();
          break;
        case 'tutors':
          await loadTutorsSection();
          break;
        case 'recordings':
          await loadRecordingsSection();
          break;
        case 'reports':
          await loadReportsSection();
          break;
        case 'billing':
          await loadBillingSection();
          break;
        case 'profile':
        default:
          break;
      }
    }

    // Child modal
    function openChildEditModal(id){
      const c = children.find(x => x.id === id);
      if(!c) return;
      document.getElementById('editChildId').value = c.id;
      document.getElementById('editChildName').value = c.name || '';
      document.getElementById('editChildDOB').value = c.date_of_birth || '';
      document.getElementById('editChildGrade').value = c.grade_level || '';
      document.getElementById('editChildEmergency').value = c.emergency_contact || '';
      document.getElementById('editChildMedical').value = c.medical_info || '';
      document.getElementById('editChildPreferences').value = c.learning_preferences || '';
      document.getElementById('childEditModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    function closeChildEditModal(){
      document.getElementById('childEditModal').classList.remove('active');
      document.body.style.overflow = 'auto';
    }
    async function saveChild(e){
      e.preventDefault();
      const id = document.getElementById('editChildId').value;
      const updates = {
        name: document.getElementById('editChildName').value,
        date_of_birth: document.getElementById('editChildDOB').value || null,
        grade_level: document.getElementById('editChildGrade').value,
        emergency_contact: document.getElementById('editChildEmergency').value,
        medical_info: document.getElementById('editChildMedical').value,
        learning_preferences: document.getElementById('editChildPreferences').value,
        updated_at: new Date().toISOString()
      };
      const { error } = await supabase.from('children').update(updates).eq('id', id);
      if(error){ alert('Failed to update child.'); return; }
      alert('Child updated.');
      closeChildEditModal();
      await loadChildren();
      await loadChildrenSection();
      await loadOverviewCards();
      await loadReportsSection();
    }

    // Profile save
    async function saveProfile(e){
      e.preventDefault();
      const updates = {
        full_name: document.getElementById('profileFullName').value,
        phone: document.getElementById('profilePhone').value,
        address: document.getElementById('profileAddress').value,
        updated_at: new Date().toISOString()
      };
      const { error } = await supabase.from('parent_profiles').update(updates).eq('user_id', currentUser.id);
      if(error){ alert('Failed to update profile.'); return; }
      alert('Profile updated.');
      await loadProfile();
    }

    // Search and export hooks
    function hookSearch(inputId, rowsGetter, renderFn, keys){
      const input = document.getElementById(inputId);
      if(!input) return;
      input.addEventListener('input', () => {
        const q = input.value.trim().toLowerCase();
        const base = rowsGetter();
        if(!q){ renderFn(base); return; }
        const filtered = base.filter(row => {
          return keys.some(k => {
            const val = typeof k === 'function' ? k(row) : row[k];
            return String(val || '').toLowerCase().includes(q);
          });
        });
        renderFn(filtered);
      });
    }

    function hookExport(btnId, filename, rowsGetter, columns){
      const btn = document.getElementById(btnId);
      if(!btn) return;
      btn.addEventListener('click', () => {
        const rows = rowsGetter();
        exportCSV(filename, rows, columns);
      });
    }

    // Events and init
    document.getElementById('logoutLink')?.addEventListener('click', async (e) => {
      e.preventDefault();
      await supabase.auth.signOut();
      location.href = '/parent-portal.html';
    });
    document.getElementById('childEditForm')?.addEventListener('submit', saveChild);
    document.getElementById('profileForm')?.addEventListener('submit', saveProfile);

    // Tabs within Reports
    document.querySelectorAll('[data-tab]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#reports [data-tab]').forEach(b => b.classList.remove('btn-success'));
        btn.classList.add('btn-success');
        const target = btn.getAttribute('data-tab');
        document.querySelectorAll('#reports .tab-pane').forEach(p => p.style.display = (p.id === target ? 'block' : 'none'));
      });
    });
    document.getElementById('refreshReports')?.addEventListener('click', loadReportsSection);

    // Search + Export bindings
    hookSearch('childrenSearch', () => cache.children, renderChildrenTable, ['name','grade_level','status','emergency_contact']);
    hookExport('childrenExport', 'children.csv', () => cache.children, [
      { label:'Name', key:'name' },
      { label:'DOB', get:r=>fmtDate(r.date_of_birth) },
      { label:'Age', get:r=>yearsFrom(r.date_of_birth) },
      { label:'Grade', key:'grade_level' },
      { label:'Status', key:'status' },
      { label:'Enrolled', get:r=>fmtDate(r.enrollment_date) },
      { label:'Emergency', key:'emergency_contact' }
    ]);

    hookSearch('lessonsSearch', () => cache.lessons, renderLessonsTable, [
      r=>r.children?.name, r=>r.subjects?.name, r=>r.tutors?.full_name, 'status'
    ]);
    hookExport('lessonsExport', 'lessons.csv', () => cache.lessons, [
      { label:'Date', get:r=>fmtDate(r.scheduled_at) },
      { label:'Time', get:r=>fmtTime(r.scheduled_at) },
      { label:'Child', get:r=>r.children?.name },
      { label:'Subject', get:r=>r.subjects?.name },
      { label:'Tutor', get:r=>r.tutors?.full_name },
      { label:'Status', key:'status' },
      { label:'Meeting URL', key:'meeting_url' }
    ]);

    hookSearch('tutorsSearch', () => cache.tutors, renderTutorsTable, [ r=>r.tutors?.full_name, r=>r.children?.name, r=>r.subjects?.name, 'status' ]);
    hookExport('tutorsExport', 'tutors.csv', () => cache.tutors, [
      { label:'Tutor', get:r=>r.tutors?.full_name },
      { label:'Child', get:r=>r.children?.name },
      { label:'Subject', get:r=>r.subjects?.name },
      { label:'Status', key:'status' }
    ]);

    hookSearch('recordingsSearch', () => cache.recordings, renderRecordingsTable, [ r=>r.children?.name, r=>r.subjects?.name ]);
    hookExport('recordingsExport', 'recordings.csv', () => cache.recordings, [
      { label:'Date', get:r=>fmtDate(r.recorded_at) },
      { label:'Child', get:r=>r.children?.name },
      { label:'Subject', get:r=>r.subjects?.name },
      { label:'Duration', key:'duration' },
      { label:'URL', key:'recording_url' }
    ]);

    hookSearch('assessmentsSearch', () => cache.assessments, renderAssessmentsTable, [
      r=>r.children?.name, r=>r.subjects?.name, 'title','type','feedback'
    ]);
    hookExport('assessmentsExport', 'assessments.csv', () => cache.assessments, [
      { label:'Date', get:r=>fmtDate(r.conducted_at) },
      { label:'Child', get:r=>r.children?.name },
      { label:'Subject', get:r=>r.subjects?.name },
      { label:'Title', key:'title' },
      { label:'Type', key:'type' },
      { label:'Grade', get:r=>r.grade },
      { label:'Max Grade', get:r=>r.max_grade },
      { label:'Feedback', key:'feedback' }
    ]);

    hookSearch('progressSearch', () => cache.progress, renderProgressTable, [
      r=>r.children?.name, r=>r.subjects?.name, 'strengths', 'areas_of_improvement'
    ]);
    hookExport('progressExport', 'progress_records.csv', () => cache.progress, [
      { label:'Date', get:r=>fmtDate(r.recorded_at) },
      { label:'Child', get:r=>r.children?.name },
      { label:'Subject', get:r=>r.subjects?.name },
      { label:'Score', get:r=>r.score },
      { label:'Strengths', get:r=>r.strengths },
      { label:'Improvement', get:r=>r.areas_of_improvement },
      { label:'Recorded By', get:r=>r.tutors?.full_name }
    ]);

    hookSearch('billingSearch', () => cache.billing, renderBillingTable, ['description','status','payment_method','transaction_id','currency']);
    hookExport('billingExport', 'billing.csv', () => cache.billing, [
      { label:'Created', get:r=>fmtDate(r.created_at) },
      { label:'Description', key:'description' },
      { label:'Amount', get:r=>Number(r.amount||0).toFixed(2) },
      { label:'Currency', key:'currency' },
      { label:'Status', key:'status' },
      { label:'Due Date', get:r=>fmtDate(r.due_date) },
      { label:'Paid At', get:r=>fmtDate(r.paid_at) },
      { label:'Payment Method', key:'payment_method' },
      { label:'Transaction ID', key:'transaction_id' }
    ]);

    // Global search: lightweight demo (filters children by default)
    document.getElementById('globalSearch')?.addEventListener('input', (e)=>{
      const q = e.target.value.toLowerCase();
      if(location.hash.replace('#','') !== 'children'){ location.hash = '#children'; }
      const base = cache.children;
      const filtered = q ? base.filter(r => [r.name, r.grade_level, r.status, r.emergency_contact].some(v => String(v||'').toLowerCase().includes(q))) : base;
      renderChildrenTable(filtered);
    });

    // Notifications placeholder
    document.getElementById('notifBtn')?.addEventListener('click', ()=> alert('Notifications coming soon.'));

    // Auth listener
    supabase.auth.onAuthStateChange((event, session) => {
      if(event === 'SIGNED_OUT' || !session){ location.href='/parent-portal.html'; }
    });

    // Boot
    (async function init(){
      const user = await ensureAuth(); if(!user) return;
      await loadProfile();
      await loadChildren();

      // Initial route
      routeFromHash();

      // Preload some data for snappy UX
      loadDashboardStats();
      loadOverviewCards();
      loadLessonsSection();
      loadTutorsSection();
      loadRecordingsSection();
      loadReportsSection();
      loadBillingSection();
    })();
  </script>
</body>
</html>