<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" sizes="32x32" href="/Images/logo.jpg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parent Dashboard - Baobab Online Academy</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --primary: #0066FF;
      --primary-hover: #0052CC;
      --primary-light: #E6F2FF;
      --secondary: #1DB584;
      --secondary-hover: #16A076;
      --secondary-light: #E6F9F4;
      --accent: #FF6B35;
      --accent-hover: #E55A2B;
      --accent-light: #FFF0ED;
      --warning: #FFB800;
      --warning-light: #FFF8E1;
      --success: #00C851;
      --success-light: #E8F5E8;
      --danger: #FF4444;
      --danger-light: #FFEBEE;
      
      --gray-50: #F8FAFC;
      --gray-100: #F1F5F9;
      --gray-200: #E2E8F0;
      --gray-300: #CBD5E1;
      --gray-400: #94A3B8;
      --gray-500: #64748B;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1E293B;
      --gray-900: #0F172A;
      
      --white: #FFFFFF;
      --black: #000000;
      
      --shadow-xs: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --shadow-2xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);
      
      --border-radius: 12px;
      --border-radius-lg: 16px;
      --border-radius-xl: 20px;
      
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--gray-800);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--gray-200);
      box-shadow: var(--shadow-sm);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1;
      min-width: 0;
    }

    .menu-toggle {
      display: none;
      width: 40px;
      height: 40px;
      border: none;
      background: var(--gray-100);
      border-radius: var(--border-radius);
      color: var(--gray-600);
      cursor: pointer;
      transition: var(--transition);
      flex-shrink: 0;
    }

    .menu-toggle:hover {
      background: var(--gray-200);
      color: var(--gray-800);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      flex-shrink: 0;
    }

    .brand-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: var(--border-radius);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1rem;
      box-shadow: var(--shadow-md);
    }

    .brand-text {
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 1.25rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      white-space: nowrap;
    }

    .search-container {
      flex: 1;
      max-width: 400px;
      margin: 0 1rem;
      display: none;
    }

    .search-wrapper {
      position: relative;
    }

    .search-input {
      width: 100%;
      height: 40px;
      padding: 0 0.75rem 0 2.5rem;
      border: 2px solid var(--gray-200);
      border-radius: var(--border-radius-lg);
      background: var(--white);
      font-size: 0.9rem;
      transition: var(--transition);
      outline: none;
    }

    .search-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    .search-icon {
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray-400);
      font-size: 1rem;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
    }

    .notification-btn {
      position: relative;
      width: 40px;
      height: 40px;
      border: none;
      background: var(--gray-100);
      border-radius: var(--border-radius);
      color: var(--gray-600);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .notification-btn:hover {
      background: var(--gray-200);
      color: var(--gray-800);
    }

    .notification-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      width: 18px;
      height: 18px;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      font-size: 0.7rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
    }

    .user-menu {
      position: relative;
      cursor: pointer;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem;
      border-radius: var(--border-radius-lg);
      transition: var(--transition);
    }

    .user-profile:hover {
      background: var(--gray-100);
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: var(--border-radius);
      background: linear-gradient(135deg, var(--accent), var(--warning));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 0.9rem;
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      flex-shrink: 0;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-info {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .user-name {
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--gray-800);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-role {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    /* Layout */
    .app-layout {
      display: flex;
      min-height: calc(100vh - 64px);
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 1rem;
      gap: 1.5rem;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      flex-shrink: 0;
      padding: 1.5rem 0;
    }

    .sidebar-nav {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius-xl);
      box-shadow: var(--shadow-lg);
      padding: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .nav-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .nav-item {
      position: relative;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: var(--border-radius);
      color: var(--gray-600);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.9rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .nav-link::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 0;
      height: 100%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      transition: var(--transition);
      z-index: -1;
    }

    .nav-link:hover {
      color: var(--primary);
      background: var(--primary-light);
      transform: translateX(4px);
    }

    .nav-link.active {
      color: white;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      box-shadow: var(--shadow-md);
    }

    .nav-link.active::before {
      width: 100%;
    }

    .nav-icon {
      font-size: 1rem;
      width: 18px;
      text-align: center;
      flex-shrink: 0;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 1.5rem 0;
      min-width: 0;
    }

    .section {
      display: none;
      animation: fadeIn 0.3s ease-in-out;
    }

    .section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Welcome Banner */
    .welcome-banner {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: var(--border-radius-xl);
      padding: 2rem;
      color: white;
      margin-bottom: 1.5rem;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-xl);
    }

    .welcome-banner::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: pulse 4s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1) rotate(0deg); }
      50% { transform: scale(1.1) rotate(180deg); }
    }

    .welcome-content {
      position: relative;
      z-index: 1;
    }

    .welcome-title {
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 1.8rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
      line-height: 1.2;
    }

    .welcome-subtitle {
      font-size: 1rem;
      opacity: 0.9;
      margin-bottom: 1.5rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--border-radius-lg);
      padding: 1rem;
      text-align: center;
      transition: var(--transition);
    }

    .stat-card:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 0.25rem;
      line-height: 1;
    }

    .stat-label {
      font-size: 0.85rem;
      opacity: 0.9;
      font-weight: 500;
    }

    /* Cards */
    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--border-radius-xl);
      box-shadow: var(--shadow-lg);
      margin-bottom: 1.5rem;
      overflow: hidden;
    }

    .card-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .card-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--gray-800);
    }

    .card-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--border-radius);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.1rem;
      box-shadow: var(--shadow-md);
      flex-shrink: 0;
    }

    .card-actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .card-content {
      padding: 1.5rem;
    }

    /* Agreement Specific Styles */
    .agreement-document {
      background: var(--white);
      border-radius: var(--border-radius-lg);
      padding: 2.5rem;
      margin: 1.5rem 0;
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--gray-200);
      font-family: 'Inter', sans-serif;
      line-height: 1.8;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      position: relative;
    }

    .agreement-header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 2px solid var(--primary);
    }

    .agreement-title {
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 1.75rem;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 0.5rem;
      letter-spacing: -0.025em;
    }

    .agreement-subtitle {
      color: var(--gray-600);
      font-size: 0.95rem;
      font-weight: 500;
    }

    .agreement-section {
      margin-bottom: 2rem;
    }

    .agreement-section-title {
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--gray-800);
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .agreement-section-icon {
      width: 24px;
      height: 24px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.75rem;
      flex-shrink: 0;
    }

    .agreement-content p {
      margin-bottom: 0.75rem;
      color: var(--gray-700);
      font-size: 0.95rem;
    }

    .agreement-list {
      list-style: none;
      padding-left: 0;
      margin: 1rem 0;
    }

    .agreement-list li {
      margin-bottom: 0.5rem;
      padding-left: 1.5rem;
      position: relative;
      color: var(--gray-700);
      font-size: 0.95rem;
    }

    .agreement-list li::before {
      content: '‚óè';
      color: var(--primary);
      font-weight: bold;
      position: absolute;
      left: 0;
      top: 0;
    }

    .highlight-info {
      background: linear-gradient(135deg, var(--primary-light), var(--secondary-light));
      border: 1px solid var(--primary);
      border-radius: var(--border-radius);
      padding: 1rem 1.25rem;
      margin: 1rem 0;
      position: relative;
      overflow: hidden;
    }

    .highlight-info::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
    }

    .highlight-info strong {
      color: var(--primary);
      font-weight: 700;
    }

    .signature-section {
      margin-top: 3rem;
      padding-top: 2rem;
      border-top: 2px solid var(--gray-200);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }

    .signature-block {
      text-align: center;
      padding: 1.5rem;
      background: var(--gray-50);
      border-radius: var(--border-radius);
      border: 1px solid var(--gray-200);
    }

    .signature-line {
      border-bottom: 2px solid var(--gray-400);
      margin: 2rem 0 0.5rem;
      height: 1px;
      position: relative;
    }

    .signature-image {
      max-width: 150px;
      max-height: 80px;
      margin: 1rem auto;
      display: block;
      border: 1px solid var(--gray-200);
      border-radius: var(--border-radius);
    }

    .signature-upload {
      position: relative;
      display: inline-block;
      margin: 1rem 0;
    }

    .signature-upload input {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .signature-upload-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 0.85rem;
      transition: var(--transition);
    }

    .signature-upload-btn:hover {
      background: var(--primary-hover);
    }

    .signature-title {
      font-weight: 700;
      color: var(--gray-800);
      margin-bottom: 0.25rem;
    }

    .signature-subtitle {
      font-size: 0.85rem;
      color: var(--gray-500);
      font-style: italic;
    }

    .agreement-watermark {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-45deg);
      font-size: 8rem;
      color: rgba(0, 102, 255, 0.03);
      font-weight: 900;
      pointer-events: none;
      z-index: 0;
      font-family: 'Plus Jakarta Sans', sans-serif;
    }

    .agreement-content {
      position: relative;
      z-index: 1;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      border: none;
      border-radius: var(--border-radius);
      font-weight: 600;
      font-size: 0.85rem;
      text-decoration: none;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-hover));
      color: white;
      box-shadow: var(--shadow-md);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-700);
      border: 1px solid var(--gray-200);
    }

    .btn-secondary:hover {
      background: var(--gray-200);
      color: var(--gray-800);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--secondary), var(--secondary-hover));
      color: white;
      box-shadow: var(--shadow-md);
    }

    .btn-warning {
      background: linear-gradient(135deg, var(--warning), #FF9800);
      color: white;
      box-shadow: var(--shadow-md);
    }

    .btn-sm {
      padding: 0.5rem 0.875rem;
      font-size: 0.8rem;
    }

    /* Forms */
    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--gray-700);
      font-size: 0.9rem;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 0.75rem 0.875rem;
      border: 2px solid var(--gray-200);
      border-radius: var(--border-radius);
      font-size: 0.9rem;
      transition: var(--transition);
      background: var(--white);
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    textarea.form-input {
      min-height: 100px;
      resize: vertical;
    }

    /* File Upload */
    .file-upload {
      position: relative;
      display: inline-block;
    }

    .file-upload-input {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-upload-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      background: var(--gray-100);
      border: 2px dashed var(--gray-300);
      border-radius: var(--border-radius);
      color: var(--gray-600);
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }

    .file-upload-btn:hover {
      background: var(--gray-200);
      border-color: var(--gray-400);
    }

    /* Tables */
    .table-container {
      overflow: auto;
      border-radius: var(--border-radius-lg);
      border: 1px solid var(--gray-200);
      background: var(--white);
    }

    .table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .table th {
      background: var(--gray-50);
      padding: 0.875rem 1rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.8rem;
      color: var(--gray-600);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--gray-200);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .table td {
      padding: 0.875rem 1rem;
      border-bottom: 1px solid var(--gray-100);
      vertical-align: middle;
      font-size: 0.9rem;
    }

    .table tbody tr {
      transition: var(--transition);
    }

    .table tbody tr:hover {
      background: var(--gray-50);
    }

    /* Expandable text cells */
    .expandable-text {
      max-width: 200px;
      position: relative;
    }

    .text-preview {
      max-height: 40px;
      overflow: hidden;
      line-height: 1.4;
    }

    .text-full {
      display: none;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    .text-toggle {
      color: var(--primary);
      cursor: pointer;
      font-size: 0.8rem;
      margin-top: 0.25rem;
      text-decoration: underline;
    }

    .text-toggle:hover {
      color: var(--primary-hover);
    }

    /* Badges */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.625rem;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.25px;
    }

    .badge-success {
      background: var(--success-light);
      color: var(--success);
    }

    .badge-warning {
      background: var(--warning-light);
      color: var(--warning);
    }

    .badge-danger {
      background: var(--danger-light);
      color: var(--danger);
    }

    .badge-primary {
      background: var(--primary-light);
      color: var(--primary);
    }

    .badge-secondary {
      background: var(--gray-100);
      color: var(--gray-600);
    }

    /* Progress bars for overview */
    .progress-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: var(--border-radius);
      margin-bottom: 0.75rem;
      transition: var(--transition);
    }

    .progress-item:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .progress-info {
      flex: 1;
      min-width: 0;
    }

    .progress-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
    }

    .progress-subtitle {
      font-size: 0.8rem;
      color: var(--gray-500);
    }

    .progress-visual {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-shrink: 0;
    }

    .progress-bar {
      width: 80px;
      height: 6px;
      background: var(--gray-200);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--secondary), var(--primary));
      border-radius: 3px;
      transition: width 0.6s ease;
    }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1500;
      padding: 1rem;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--white);
      border-radius: var(--border-radius-xl);
      box-shadow: var(--shadow-2xl);
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow: auto;
      position: relative;
    }

    .modal-header {
      padding: 1.5rem 1.5rem 1rem;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--gray-800);
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border: none;
      background: var(--gray-100);
      border-radius: var(--border-radius);
      color: var(--gray-500);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      background: var(--gray-200);
      color: var(--gray-700);
    }

    .modal-body {
      padding: 1.5rem;
    }

    /* Loading states */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      padding: 1.5rem;
      color: var(--gray-500);
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--gray-200);
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--gray-500);
    }

    .empty-state i {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
      color: var(--gray-300);
    }

    /* Bottom Navigation */
    .bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--gray-200);
      padding: 0.75rem 0;
      z-index: 1000;
    }

    .bottom-nav-container {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      max-width: 500px;
      margin: 0 auto;
    }

    .bottom-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.125rem;
      padding: 0.375rem;
      text-decoration: none;
      color: var(--gray-500);
      font-size: 0.7rem;
      font-weight: 500;
      transition: var(--transition);
    }

    .bottom-nav-item.active {
      color: var(--primary);
    }

    .bottom-nav-item i {
      font-size: 1.1rem;
    }

    /* Profile image upload styles */
    .avatar-upload {
      position: relative;
      display: inline-block;
    }

    .avatar-upload .user-avatar {
      cursor: pointer;
      transition: var(--transition);
    }

    .avatar-upload:hover .user-avatar {
      transform: scale(1.05);
    }

    .avatar-upload .upload-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      border-radius: var(--border-radius);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: var(--transition);
      cursor: pointer;
    }

    .avatar-upload:hover .upload-overlay {
      opacity: 1;
    }

    .upload-overlay i {
      color: white;
      font-size: 1.125rem;
    }

    /* Tab navigation for reports */
    .tab-nav {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.25rem;
      border-bottom: 1px solid var(--gray-200);
      padding-bottom: 0.75rem;
    }

    .tab-btn {
      padding: 0.625rem 1.25rem;
      border: none;
      background: transparent;
      color: var(--gray-600);
      font-weight: 500;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      font-size: 0.9rem;
    }

    .tab-btn.active {
      color: var(--primary);
      background: var(--primary-light);
    }

    .tab-btn:hover:not(.active) {
      color: var(--gray-800);
      background: var(--gray-100);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Chart containers */
    .chart-container {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: var(--border-radius);
      padding: 1rem;
      margin-bottom: 1.25rem;
      height: 250px;
    }

    /* PDF Download Button */
    .download-pdf-btn {
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: var(--border-radius);
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: var(--shadow-md);
    }

    .download-pdf-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .app-layout {
        padding: 0 0.75rem;
        gap: 1rem;
      }

      .sidebar {
        width: 240px;
      }

      .welcome-title {
        font-size: 1.6rem;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .agreement-document {
        padding: 2rem;
        margin: 1rem 0;
      }

      .signature-section {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
    }

    @media (max-width: 768px) {
      .header-content {
        padding: 0 0.75rem;
        height: 56px;
      }

      .brand-text {
        font-size: 1.1rem;
      }

      .brand-icon {
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
      }

      .user-avatar {
        width: 32px;
        height: 32px;
        font-size: 0.8rem;
      }

      .user-info {
        display: none;
      }

      .search-container {
        display: none;
      }

      .menu-toggle {
        display: flex;
      }

      .app-layout {
        flex-direction: column;
        padding: 0 0.75rem;
        min-height: calc(100vh - 56px);
      }

      .sidebar {
        position: fixed;
        top: 56px;
        left: -280px;
        height: calc(100vh - 56px);
        width: 260px;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        z-index: 1200;
        transition: var(--transition-slow);
        padding: 1rem;
        overflow-y: auto;
      }

      .sidebar.active {
        left: 0;
      }

      .sidebar-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 1100;
        display: none;
      }

      .sidebar-overlay.active {
        display: block;
      }

      .main-content {
        padding: 1rem 0 5rem;
      }

      .welcome-banner {
        padding: 1.5rem;
        margin-bottom: 1rem;
      }

      .welcome-title {
        font-size: 1.4rem;
      }

      .welcome-subtitle {
        font-size: 0.9rem;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
      }

      .stat-card {
        padding: 0.75rem;
      }

      .stat-number {
        font-size: 1.5rem;
      }

      .stat-label {
        font-size: 0.75rem;
      }

      .card-header {
        padding: 1rem;
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
      }

      .card-content {
        padding: 1rem;
      }

      .card-title {
        font-size: 1rem;
      }

      .card-icon {
        width: 36px;
        height: 36px;
        font-size: 1rem;
      }

      .progress-item {
        padding: 0.75rem;
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
      }

      .progress-visual {
        justify-content: space-between;
      }

      .progress-bar {
        width: 100px;
      }

      .bottom-nav {
        display: block;
      }

      .chart-container {
        height: 200px;
        padding: 0.75rem;
      }

      .agreement-document {
        padding: 1.5rem;
        margin: 0.5rem 0;
      }

      .agreement-title {
        font-size: 1.5rem;
      }

      .agreement-section-title {
        font-size: 1.1rem;
      }

      /* Mobile table view */
      .table-container {
        border: none;
        background: transparent;
      }

      .table,
      .table thead,
      .table tbody,
      .table th,
      .table td,
      .table tr {
        display: block;
      }

      .table thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
      }

      .table tr {
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius);
        margin-bottom: 0.75rem;
        box-shadow: var(--shadow-sm);
        padding: 0.75rem;
      }

      .table td {
        border: none;
        padding: 0.375rem 0;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        font-size: 0.85rem;
        gap: 1rem;
      }

      .table td::before {
        content: attr(data-label);
        font-weight: 600;
        color: var(--gray-600);
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 0.5px;
        flex-shrink: 0;
        min-width: 80px;
      }

      .table td .expandable-text {
        max-width: none;
        flex: 1;
      }

      .modal-content {
        max-width: calc(100vw - 2rem);
      }
    }

    @media (max-width: 480px) {
      .header-content {
        padding: 0 0.5rem;
      }

      .app-layout {
        padding: 0 0.5rem;
      }

      .welcome-banner {
        padding: 1rem;
      }

      .welcome-title {
        font-size: 1.25rem;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .card-header {
        padding: 0.75rem;
      }

      .card-content {
        padding: 0.75rem;
      }

      .chart-container {
        height: 180px;
        padding: 0.5rem;
      }

      .progress-item {
        padding: 0.5rem;
      }

      .agreement-document {
        padding: 1rem;
      }

      .agreement-title {
        font-size: 1.25rem;
      }
    }

    /* Desktop search display */
    @media (min-width: 769px) {
      .search-container {
        display: block;
      }
    }

    @media print {
      .header, .sidebar, .bottom-nav, .card-header, .btn, .signature-upload {
        display: none !important;
      }
      
      .app-layout {
        flex-direction: column;
        max-width: none;
        margin: 0;
        padding: 0;
      }
      
      .main-content {
        padding: 0;
      }
      
      .agreement-document {
        box-shadow: none;
        border: 1px solid #000;
        margin: 0;
        padding: 2rem;
        background: white;
      }
      
      .card {
        box-shadow: none;
        border: none;
        background: transparent;
      }
      
      .card-content {
        padding: 0;
      }

      .agreement-watermark {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <button class="menu-toggle" id="menuToggle">
          <i class="fas fa-bars"></i>
        </button>
        <a href="#overview" class="brand">
          <div class="brand-icon">
            <i class="fas fa-tree"></i>
          </div>
          <div class="brand-text">Baobab Parent Portal</div>
        </a>
      </div>

      <div class="search-container">
        <div class="search-wrapper">
          <i class="fas fa-search search-icon"></i>
          <input type="search" class="search-input" id="globalSearch" placeholder="Search children, lessons, reports...">
        </div>
      </div>

      <div class="header-right">
        <button class="notification-btn" id="notificationBtn">
          <i class="fas fa-bell"></i>
          <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
        </button>
        
        <div class="user-menu" id="userMenu">
          <div class="user-profile">
            <div class="user-avatar" id="userAvatar">
              <span id="userInitials">P</span>
            </div>
            <div class="user-info">
              <div class="user-name" id="userName">Loading...</div>
              <div class="user-role">Parent</div>
            </div>
            <i class="fas fa-chevron-down" style="color: var(--gray-400); font-size: 0.7rem; display: none;"></i>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- App Layout -->
  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <nav class="sidebar-nav">
        <ul class="nav-list">
          <li class="nav-item">
            <a href="#overview" class="nav-link active" data-section="overview">
              <i class="fas fa-home nav-icon"></i>
              Dashboard Overview
            </a>
          </li>
          <li class="nav-item">
            <a href="#children" class="nav-link" data-section="children">
              <i class="fas fa-child nav-icon"></i>
              Children Management
            </a>
          </li>
          <li class="nav-item">
            <a href="#lessons" class="nav-link" data-section="lessons">
              <i class="fas fa-calendar-alt nav-icon"></i>
              Upcoming Lessons
            </a>
          </li>
          <li class="nav-item">
            <a href="#tutors" class="nav-link" data-section="tutors">
              <i class="fas fa-chalkboard-teacher nav-icon"></i>
              Assigned Tutors
            </a>
          </li>
          <li class="nav-item">
            <a href="#reports" class="nav-link" data-section="reports">
              <i class="fas fa-chart-bar nav-icon"></i>
              Reports & Assessments
            </a>
          </li>
          <li class="nav-item">
            <a href="#billing" class="nav-link" data-section="billing">
              <i class="fas fa-credit-card nav-icon"></i>
              Billing & Payments
            </a>
          </li>
          <li class="nav-item">
            <a href="#agreement" class="nav-link" data-section="agreement">
              <i class="fas fa-file-contract nav-icon"></i>
              Parent Agreement
            </a>
          </li>
          <li class="nav-item">
            <a href="#profile" class="nav-link" data-section="profile">
              <i class="fas fa-user-edit nav-icon"></i>
              My Profile
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" id="logoutLink">
              <i class="fas fa-sign-out-alt nav-icon"></i>
              Logout
            </a>
          </li>
        </ul>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Overview Section -->
      <section id="overview" class="section active">
        <div class="welcome-banner">
          <div class="welcome-content">
            <h1 class="welcome-title">Welcome back, <span id="parentName">Parent</span>! üëã</h1>
            <p class="welcome-subtitle">Your children are making amazing progress. Here's a quick snapshot of today.</p>
            
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-number" id="totalLessons">0</div>
                <div class="stat-label">Lessons Completed</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="averageGrade">0%</div>
                <div class="stat-label">Average Grade</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="culturalMilestones">0</div>
                <div class="stat-label">Cultural Milestones</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="activeTutors">0</div>
                <div class="stat-label">Active Tutors</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <div class="card-icon" style="background: linear-gradient(135deg, var(--secondary), #16A076);">
                <i class="fas fa-chart-line"></i>
              </div>
              Recent Progress
            </div>
            <div class="card-actions">
              <a href="#reports" class="btn btn-secondary" data-section="reports">
                <i class="fas fa-arrow-right"></i>
                View Full Reports
              </a>
            </div>
          </div>
          <div class="card-content">
            <div id="overviewProgress">
              <div class="loading">
                <div class="spinner"></div>
                Loading progress...
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <div class="card-icon" style="background: linear-gradient(135deg, var(--warning), #FF9800);">
                <i class="fas fa-calendar-alt"></i>
              </div>
              Upcoming Lessons
            </div>
          </div>
          <div class="card-content">
            <div id="overviewLessons">
              <div class="loading">
                <div class="spinner"></div>
                Loading lessons...
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Children Section -->
      <section id="children" class="section">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <div class="card-icon" style="background: linear-gradient(135deg, var(--primary), #0052CC);">
                <i class="fas fa-children"></i>
              </div>
              Children Management
            </div>
            <div class="card-actions">
              <div class="search-wrapper" style="min-width: 200px;">
                <i class="fas fa-search search-icon"></i>
                <input type="search" class="search-input" id="childrenSearch" placeholder="Search children...">
              </div>
              <button class="btn btn-secondary" id="childrenExport">
                <i class="fas fa-download"></i>
                Export CSV
              </button>
            </div>
          </div>
          <div class="card-content">
            <div class="table-container">
              <table class="table" id="childrenTable">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>DOB</th>
                    <th>Age</th>
                    <th>Grade</th>
                    <th>Class Type</th>
                    <th>Status</th>
                    <th>Enrolled</th>
                    <th>Emergency Contact</th>
                    <th>Supporting Tutors</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="childrenTbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Lessons Section -->
      <section id="lessons" class="section">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <div class="card-icon" style="background: linear-gradient(135deg, var(--warning), #FF9800);">
                <i class="fas fa-calendar-days"></i>
              </div>
              Upcoming Lessons
            </div>
            <div class="card-actions">
              <div class="search-wrapper" style="min-width: 200px;">
                <i class="fas fa-search search-icon"></i>
                <input type="search" class="search-input" id="lessonsSearch" placeholder="Search lessons...">
              </div>
              <button class="btn btn-secondary" id="lessonsExport">
                <i class="fas fa-download"></i>
                Export CSV
              </button>
            </div>
          </div>
          <div class="card-content">
            <div class="table-container">
              <table class="table" id="lessonsTable">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Child</th>
                    <th>Subject</th>
                    <th>Tutor</th>
                    <th>Status</th>
                    <th>Join</th>
                  </tr>
                </thead>
                <tbody id="lessonsTbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Tutors Section -->
      <section id="tutors" class="section">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <div class="card-icon" style="background: linear-gradient(135deg, var(--secondary), #16A076);">
                <i class="fas fa-user-tie"></i>
              </div>
              Assigned Tutors
            </div>
            <div class="card-actions">
              <div class="search-wrapper" style="min-width: 200px;">
                <i class="fas fa-search search-icon"></i>
                <input type="search" class="search-input" id="tutorsSearch" placeholder="Search tutors...">
              </div>
              <button class="btn btn-secondary" id="tutorsExport">
                <i class="fas fa-download"></i>
                Export CSV
              </button>
            </div>
          </div>
          <div class="card-content">
            <div class="table-container">
              <table class="table" id="tutorsTable">
                <thead>
                  <tr>
                    <th>Tutor</th>
                    <th>Child</th>
                    <th>Subject</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="tutorsTbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Reports Section -->
      <section id="reports" class="section">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <div class="card-icon" style="background: linear-gradient(135deg, var(--primary), #0052CC);">
                <i class="fas fa-chart-bar"></i>
              </div>
              Reports & Assessments
            </div>
            <div class="card-actions">
              <button class="download-pdf-btn" id="downloadReportsPDF">
                <i class="fas fa-file-pdf"></i>
                Download PDF Report
              </button>
              <button class="btn btn-secondary" id="refreshReports">
                <i class="fas fa-refresh"></i>
                Refresh
              </button>
            </div>
          </div>
          <div class="card-content">
            <div class="tab-nav">
              <button class="tab-btn active" data-tab="assessments">Assessments</button>
              <button class="tab-btn" data-tab="progress">Progress Records</button>
            </div>

            <div id="assessments" class="tab-content active">
              <div class="card-actions" style="margin-bottom: 1.25rem;">
                <div class="search-wrapper" style="min-width: 200px;">
                  <i class="fas fa-search search-icon"></i>
                  <input type="search" class="search-input" id="assessmentsSearch" placeholder="Search assessments...">
                </div>
                <button class="btn btn-secondary" id="assessmentsExport">
                  <i class="fas fa-download"></i>
                  Export CSV
                </button>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem; margin-bottom: 1.5rem;">
                <div class="chart-container">
                  <canvas id="avgBySubjectChart"></canvas>
                </div>
                <div class="chart-container">
                  <canvas id="trendChart"></canvas>
                </div>
              </div>

              <div class="table-container">
                <table class="table" id="assessmentsTable">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Child</th>
                      <th>Subject</th>
                      <th>Title</th>
                      <th>Type</th>
                      <th>Score</th>
                      <th>Feedback</th>
                    </tr>
                  </thead>
                  <tbody id="assessmentsTbody"></tbody>
                </table>
              </div>
            </div>

            <div id="progress" class="tab-content">
              <div class="card-actions" style="margin-bottom: 1.25rem;">
                <div class="search-wrapper" style="min-width: 200px;">
                  <i class="fas fa-search search-icon"></i>
                  <input type="search" class="search-input" id="progressSearch" placeholder="Search progress records...">
                </div>
                <button class="btn btn-secondary" id="progressExport">
                  <i class="fas fa-download"></i>
                  Export CSV
                </button>
              </div>

              <div class="table-container">
                <table class="table" id="progressTable">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Child</th>
                      <th>Subject</th>
                      <th>Score</th>
                      <th>Strengths</th>
                      <th>Improvement</th>
                      <th>Notes</th>
                      <th>Recorded By</th>
                    </tr>
                  </thead>
                  <tbody id="progressTbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Billing Section -->
      <section id="billing" class="section">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <div class="card-icon" style="background: linear-gradient(135deg, var(--accent), #E55A2B);">
                <i class="fas fa-file-invoice-dollar"></i>
              </div>
              Billing & Payments
            </div>
            <div class="card-actions">
              <div class="search-wrapper" style="min-width: 200px;">
                <i class="fas fa-search search-icon"></i>
                <input type="search" class="search-input" id="billingSearch" placeholder="Search billing...">
              </div>
              <button class="btn btn-secondary" id="billingExport">
                <i class="fas fa-download"></i>
                Export CSV
              </button>
            </div>
          </div>
          <div class="card-content">
            <div class="table-container">
              <table class="table" id="billingTable">
                <thead>
                  <tr>
                    <th>Created</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Due</th>
                    <th>Paid At</th>
                    <th>Method</th>
                    <th>Txn ID</th>
                  </tr>
                </thead>
                <tbody id="billingTbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Agreement Section -->
      <section id="agreement" class="section">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <div class="card-icon" style="background: linear-gradient(135deg, var(--primary), var(--secondary));">
                <i class="fas fa-file-contract"></i>
              </div>
              Parent Agreement
            </div>
            <div class="card-actions">
              <button class="btn btn-secondary" id="printAgreement">
                <i class="fas fa-print"></i>
                Print Agreement
              </button>
              <button class="btn btn-primary" id="downloadAgreementPDF">
                <i class="fas fa-download"></i>
                Download PDF
              </button>
            </div>
          </div>
          <div class="card-content">
            <div class="agreement-document" id="agreementDocument">
              <div class="agreement-watermark">BAOBAB</div>
              <div class="agreement-content">
                <div class="agreement-header">
                  <h1 class="agreement-title">PARENT AGREEMENT</h1>
                  <p class="agreement-subtitle">Baobab Online Academy ‚Ä¢ Educational Excellence</p>
                </div>

                <div class="agreement-section">
                  <p style="text-align: center; margin-bottom: 2rem; font-size: 1rem; line-height: 1.8;">
                    This Agreement is made on the <strong id="agreementDate">_______</strong> day of <strong id="agreementMonth">_______</strong> 2025 between <strong>Baobab Online Academy</strong> and <strong id="parentNameAgreement">_______</strong>, regarding the education of her children, <span id="childrenListAgreement">_______</span>.
                  </p>
                </div>

                <div class="agreement-section">
                  <h2 class="agreement-section-title">
                    <div class="agreement-section-icon">
                      <i class="fas fa-graduation-cap"></i>
                    </div>
                    Enrollment & Subjects
                  </h2>
                  <div class="agreement-content">
                    <div class="highlight-info">
                      <div id="subjectsEnrollmentAgreement">
                        <p>Loading enrollment details...</p>
                      </div>
                    </div>
                    <div id="tutorAssignmentsAgreement">
                      <p>Loading tutor assignments...</p>
                    </div>
                  </div>
                </div>

                <div class="agreement-section">
                  <h2 class="agreement-section-title">
                    <div class="agreement-section-icon">
                      <i class="fas fa-pound-sign"></i>
                    </div>
                    Fees
                  </h2>
                  <div class="agreement-content">
                    <div class="highlight-info">
                      <div id="feesBreakdownAgreement">
                        <p>Loading fee structure...</p>
                      </div>
                    </div>
                    <ul class="agreement-list">
                      <li>Fees must be paid before the commencement of classes.</li>
                      <li>Fees are non-refundable once the term commences.</li>
                    </ul>
                  </div>
                </div>

                <div class="agreement-section">
                  <h2 class="agreement-section-title">
                    <div class="agreement-section-icon">
                      <i class="fas fa-handshake"></i>
                    </div>
                    Learning Commitment
                  </h2>
                  <div class="agreement-content">
                    <ul class="agreement-list">
                      <li>The Academy shall provide qualified instructors and structured lesson delivery.</li>
                      <li>The Parent agrees to ensure consistent attendance and encourage children to complete assignments.</li>
                      <li>The Academy shall not be held responsible for missed lessons due to student absence.</li>
                    </ul>
                  </div>
                </div>

                <div class="agreement-section">
                  <h2 class="agreement-section-title">
                    <div class="agreement-section-icon">
                      <i class="fas fa-file-signature"></i>
                    </div>
                    Termination
                  </h2>
                  <div class="agreement-content">
                    <ul class="agreement-list">
                      <li>Either party may terminate this agreement with two (2) weeks' written notice.</li>
                      <li>No refund will be issued for partial term attendance.</li>
                    </ul>
                  </div>
                </div>

                <div class="signature-section">
                  <div class="signature-block">
                    <div class="signature-line"></div>
                    <img id="schoolSignatureImage" class="signature-image" src="Images/HOD_Signature.jpg" alt="Head of School Signature" style="display: block;">
                    <div class="signature-title">Head of School</div>
                    <div class="signature-subtitle">Baobab Online Academy</div>
                    <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--gray-600);">
                      Date: <strong id="schoolSignatureDate">_____________</strong>
                    </div>
                  </div>
                  <div class="signature-block">
                    <div class="signature-line"></div>
                    <img id="parentSignatureImage" class="signature-image" alt="Parent Signature" style="display: none;">
                    <div class="signature-upload">
                      <input type="file" id="signatureInput" accept="image/*">
                      <button class="signature-upload-btn">
                        <i class="fas fa-upload"></i>
                        Upload Signature
                      </button>
                    </div>
                    <div class="signature-title" id="parentSignatureName">Parent's Name</div>
                    <div class="signature-subtitle">Parent/Guardian</div>
                    <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--gray-600);">
                      Date: <strong id="parentSignatureDate">_____________</strong>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Profile Section -->
      <section id="profile" class="section">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <div class="card-icon" style="background: linear-gradient(135deg, var(--accent), #E55A2B);">
                <i class="fas fa-user-cog"></i>
              </div>
              My Profile
            </div>
          </div>
          <div class="card-content">
            <div style="display: grid; grid-template-columns: auto 1fr; gap: 1.5rem; align-items: start;">
              <div class="avatar-upload">
                <div class="user-avatar" style="width: 100px; height: 100px; font-size: 2rem;" id="profileAvatar">
                  <span id="profileInitials">P</span>
                  <img id="profileImage" style="display: none;" alt="Profile">
                </div>
                <div class="upload-overlay">
                  <i class="fas fa-camera"></i>
                </div>
                <input type="file" id="avatarInput" accept="image/*" style="display: none;">
              </div>
              
              <form id="profileForm">
                <div class="form-group">
                  <label class="form-label" for="profileFullName">Full Name</label>
                  <input class="form-input" id="profileFullName" name="full_name" type="text" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                  <label class="form-label" for="profileEmail">Email</label>
                  <input class="form-input" id="profileEmail" type="email" readonly>
                </div>
                <div class="form-group">
                  <label class="form-label" for="profilePhone">Phone</label>
                  <input class="form-input" id="profilePhone" name="phone" type="tel" placeholder="Enter your phone number">
                </div>
                <div class="form-group">
                  <label class="form-label" for="profileAddress">Address</label>
                  <input class="form-input" id="profileAddress" name="address" type="text" placeholder="Enter your address">
                </div>
                <button class="btn btn-primary" type="submit">
                  <i class="fas fa-save"></i>
                  Update Profile
                </button>
              </form>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <div class="bottom-nav-container">
      <a href="#overview" class="bottom-nav-item active" data-section="overview">
        <i class="fas fa-home"></i>
        <span>Home</span>
      </a>
      <a href="#children" class="bottom-nav-item" data-section="children">
        <i class="fas fa-child"></i>
        <span>Children</span>
      </a>
      <a href="#lessons" class="bottom-nav-item" data-section="lessons">
        <i class="fas fa-calendar-alt"></i>
        <span>Lessons</span>
      </a>
      <a href="#reports" class="bottom-nav-item" data-section="reports">
        <i class="fas fa-file-alt"></i>
        <span>Reports</span>
      </a>
      <a href="#profile" class="bottom-nav-item" data-section="profile">
        <i class="fas fa-user"></i>
        <span>Profile</span>
      </a>
    </div>
  </nav>

  <!-- Child Edit Modal -->
  <div class="modal" id="childEditModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Edit Child Information</h3>
        <button class="modal-close" onclick="closeChildEditModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="childEditForm">
          <input type="hidden" id="editChildId">
          <div class="form-group">
            <label class="form-label" for="editChildName">Full Name</label>
            <input class="form-input" id="editChildName" name="name" type="text" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="editChildDOB">Date of Birth</label>
            <input class="form-input" id="editChildDOB" name="date_of_birth" type="date">
          </div>
          <div class="form-group">
            <label class="form-label" for="editChildGrade">Grade Level</label>
            <input class="form-input" id="editChildGrade" name="grade_level" type="text">
          </div>
          <div class="form-group">
            <label class="form-label" for="editChildClassType">Class Type</label>
            <select class="form-select" id="editChildClassType" name="class_type">
              <option value="Group">Group Class</option>
              <option value="1-on-1">1-on-1 Class</option>
              <option value="Exam Intensive">Exam Intensive</option>
              <option value="Python Programming">Python Programming</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="editChildEmergency">Emergency Contact</label>
            <input class="form-input" id="editChildEmergency" name="emergency_contact" type="text">
          </div>
          <div class="form-group">
            <label class="form-label" for="editChildSupportingTutors">Supporting Tutors</label>
            <input class="form-input" id="editChildSupportingTutors" name="supporting_tutors" type="text" placeholder="Enter supporting tutor names (comma-separated)">
            <small style="color: var(--gray-500); font-size: 0.8rem; margin-top: 0.25rem; display: block;">
              Enter names separated by commas, e.g., "John Smith, Jane Doe"
            </small>
          </div>
          <div class="form-group">
            <label class="form-label" for="editChildMedical">Medical Information</label>
            <textarea class="form-input" id="editChildMedical" name="medical_info"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label" for="editChildPreferences">Learning Preferences</label>
            <textarea class="form-input" id="editChildPreferences" name="learning_preferences"></textarea>
          </div>
          <button class="btn btn-primary" type="submit">
            <i class="fas fa-save"></i>
            Update Child
          </button>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Supabase setup
    const SUPABASE_URL = 'https://vcxdkacxbjsgaoxbhsip.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZjeGRrYWN4YmpzZ2FveGJoc2lwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MDQ5ODMsImV4cCI6MjA2ODQ4MDk4M30.T9KhHWzHZWyaZvyeFXtBu8tPLY9JOn6_wCHcH8B46FU';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // State
    let currentUser = null;
    let parentProfile = null;
    let children = [];
    let charts = { avgBySubject: null, trend: null };
    const cache = {
      children: [],
      lessons: [],
      tutors: [],
      assessments: [],
      progress: [],
      billing: [],
      fees: [],
      subjects: []
    };

    // UI elements
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');

    // Mobile menu functionality
    function toggleSidebar(open) {
      const show = open ?? !sidebar.classList.contains('active');
      sidebar.classList.toggle('active', show);
      sidebarOverlay.classList.toggle('active', show);
      document.body.style.overflow = show ? 'hidden' : '';
      menuToggle.innerHTML = show ? '<i class="fas fa-times"></i>' : '<i class="fas fa-bars"></i>';
    }

    menuToggle?.addEventListener('click', () => toggleSidebar());
    sidebarOverlay?.addEventListener('click', () => toggleSidebar(false));

    // Navigation functionality
    function setActive(sectionId) {
      // Update sections
      document.querySelectorAll('.section').forEach(s => 
        s.classList.toggle('active', s.id === sectionId)
      );
      
      // Update nav links
      document.querySelectorAll('.nav-link').forEach(a => 
        a.classList.toggle('active', a.dataset.section === sectionId)
      );
      
      // Update bottom nav
      document.querySelectorAll('.bottom-nav-item').forEach(b => 
        b.classList.toggle('active', b.dataset.section === sectionId)
      );
      
      loadSection(sectionId);
      toggleSidebar(false);
    }

    function routeFromHash() {
      const id = (location.hash || '#overview').replace('#', '');
      setActive(id);
    }

    window.addEventListener('hashchange', routeFromHash);

    // Add click handlers for navigation
    document.querySelectorAll('[data-section]').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const section = link.dataset.section;
        location.hash = '#' + section;
      });
    });

    // User menu click handler
    document.getElementById('userMenu').addEventListener('click', () => {
      location.hash = '#profile';
    });

    // Tab functionality for reports
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Update tab content
        const target = btn.dataset.tab;
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.toggle('active', content.id === target);
        });
      });
    });

    // Helper functions
    function initialsOf(str) {
      if (!str) return 'P';
      const base = str.includes('@') ? str.split('@')[0] : str;
      const parts = base.trim().split(/\s+/).filter(Boolean);
      return (parts[0]?.[0] || base[0] || 'P').toUpperCase() + (parts[1]?.[0] || '').toUpperCase();
    }

    function fmtDate(d) { 
      if (!d) return ''; 
      const dt = new Date(d); 
      return dt.toLocaleDateString(); 
    }

    function fmtTime(d) { 
      if (!d) return ''; 
      const dt = new Date(d); 
      return dt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); 
    }

    function yearsFrom(d) {
      if (!d) return '';
      const ms = Date.now() - new Date(d).getTime();
      return Math.floor(ms / (365.25 * 24 * 60 * 60 * 1000));
    }

    function toPercent(grade, max) { 
      if (!grade && grade !== 0) return ''; 
      const denom = max || 100; 
      const pct = Math.round((Number(grade) / Number(denom)) * 100); 
      return pct + '%'; 
    }

    function statusBadge(status) {
      const s = (status || '').toLowerCase();
      let className = 'badge-secondary';
      if (s.includes('paid') || s.includes('active') || s.includes('completed')) {
        className = 'badge-success';
      } else if (s.includes('pending') || s.includes('scheduled')) {
        className = 'badge-warning';
      } else if (s.includes('failed') || s.includes('overdue') || s.includes('cancelled')) {
        className = 'badge-danger';
      }
      return `<span class="badge ${className}">${status || '‚Äî'}</span>`;
    }

    function escapeCSV(val) {
      if (val == null) return '';
      const s = String(val);
      return /[",\n]/.test(s) ? '"' + s.replace(/"/g, '""') + '"' : s;
    }

    function exportCSV(filename, rows, columns) {
      const header = columns.map(c => c.label).join(',');
      const body = rows.map(r => 
        columns.map(c => escapeCSV(c.get ? c.get(r) : r[c.key])).join(',')
      ).join('\n');
      const csv = header + '\n' + body;
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; 
      a.download = filename;
      document.body.appendChild(a); 
      a.click();
      document.body.removeChild(a); 
      URL.revokeObjectURL(url);
    }

    function numberToWords(num) {
      const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
      const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
      const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
      const thousands = ['', 'Thousand', 'Million', 'Billion'];

      if (num === 0) return 'Zero';

      function convertHundreds(n) {
        let result = '';
        if (n >= 100) {
          result += ones[Math.floor(n / 100)] + ' Hundred ';
          n %= 100;
        }
        if (n >= 20) {
          result += tens[Math.floor(n / 10)] + ' ';
          n %= 10;
        } else if (n >= 10) {
          result += teens[n - 10] + ' ';
          return result;
        }
        if (n > 0) {
          result += ones[n] + ' ';
        }
        return result;
      }

      let result = '';
      let thousandCounter = 0;

      while (num > 0) {
        if (num % 1000 !== 0) {
          result = convertHundreds(num % 1000) + thousands[thousandCounter] + ' ' + result;
        }
        num = Math.floor(num / 1000);
        thousandCounter++;
      }

      return result.trim();
    }

    // Create expandable text cell
    function createExpandableText(text, maxLength = 150) {
  if (!text || text.length <= maxLength) {
    return `<div class="expandable-text">${text || '‚Äî'}</div>`;
  }

  const preview = text.substring(0, maxLength);
  const uniqueId = 'text_' + Math.random().toString(36).substr(2, 9);
  
  return `
    <div class="expandable-text">
      <div class="text-preview" id="${uniqueId}_preview">
        ${preview}...
        <div class="text-toggle" onclick="toggleText('${uniqueId}')">Show more</div>
      </div>
      <div class="text-full" id="${uniqueId}_full" style="white-space: pre-wrap; word-wrap: break-word;">
        ${text}
        <div class="text-toggle" onclick="toggleText('${uniqueId}')">Show less</div>
      </div>
    </div>
  `;
}

    function toggleText(id) {
      const preview = document.getElementById(id + '_preview');
      const full = document.getElementById(id + '_full');
      
      if (preview.style.display === 'none') {
        preview.style.display = 'block';
        full.style.display = 'none';
      } else {
        preview.style.display = 'none';
        full.style.display = 'block';
      }
    }

    // Make toggleText global
    window.toggleText = toggleText;

    // Initialize fees table and data
    async function initializeFeesTable() {
      try {
        // Load fees into cache
        const { data: fees, error } = await supabase
          .from('fees')
          .select('*');
        
        if (error) {
          console.error('Error loading fees:', error);
          // Fallback fees
          cache.fees = [
            { grade_range: 'Grades 1-6', class_type: 'Group', amount: 40000, currency: 'NGN' },
            { grade_range: 'Grades 1-6', class_type: '1-on-1', amount: 60000, currency: 'NGN' },
            { grade_range: 'Grades 7-11', class_type: 'Group', amount: 60000, currency: 'NGN' },
            { grade_range: 'Grades 7-11', class_type: '1-on-1', amount: 100000, currency: 'NGN' },
            { grade_range: 'All Grades', class_type: 'Exam Intensive', amount: 100000, currency: 'NGN' },
            { grade_range: 'All Grades', class_type: 'Python Programming', amount: 60000, currency: 'NGN' }
          ];
        } else {
          cache.fees = fees || [];
        }
      } catch (error) {
        console.error('Error initializing fees table:', error);
        cache.fees = [];
      }
    }

    function getFeeForChild(child) {
  if (!child || !cache.fees?.length) {
    return 0;
  }

  const gradeLevel = child.grade_level ? child.grade_level.toString().trim() : '';
  const classType = child.class_type || 'Group';
  
  // Helper function to check if a grade falls within a range
  function isGradeInRange(grade, gradeRange) {
    if (!grade || !gradeRange) return false;
    
    // Handle "All Grades" case
    if (gradeRange.toLowerCase() === 'all grades') {
      return true;
    }
    
    // Extract numeric part from grade (e.g., "Grade 5" -> 5, "5" -> 5)
    const gradeNum = parseInt(grade.replace(/\D/g, ''));
    if (isNaN(gradeNum)) return false;
    
    // Parse grade range (e.g., "Grades 1-6" -> [1, 6])
    const rangeMatch = gradeRange.match(/(\d+)-(\d+)/);
    if (rangeMatch) {
      const minGrade = parseInt(rangeMatch[1]);
      const maxGrade = parseInt(rangeMatch[2]);
      return gradeNum >= minGrade && gradeNum <= maxGrade;
    }
    
    // Handle single grade (e.g., "Grade 5")
    const singleGradeMatch = gradeRange.match(/(\d+)/);
    if (singleGradeMatch) {
      const targetGrade = parseInt(singleGradeMatch[1]);
      return gradeNum === targetGrade;
    }
    
    return false;
  }
  
  // Find the matching fee based on grade range and class type
  const matchingFee = cache.fees.find(fee => {
    const gradeMatches = isGradeInRange(gradeLevel, fee.grade_range);
    const classMatches = fee.class_type.toLowerCase() === classType.toLowerCase();
    return gradeMatches && classMatches;
  });
  
  if (matchingFee) {
    return Number(matchingFee.amount) || 0;
  }
  
  // Fallback logic if no exact match is found
  console.warn(`No fee found for grade "${gradeLevel}" and class type "${classType}"`);
  
  // Extract numeric grade for fallback
  const gradeNum = parseInt((gradeLevel || '').replace(/\D/g, ''));
  
  if (isNaN(gradeNum)) {
    return 40000; // Default fallback
  }
  
  // Fallback based on common grade ranges and class types
  if (classType.toLowerCase().includes('1-on-1')) {
    return gradeNum >= 7 ? 100000 : 60000;
  } else if (classType.toLowerCase().includes('exam intensive')) {
    return 100000;
  } else if (classType.toLowerCase().includes('python')) {
    return 60000;
  } else {
    // Group class fallback
    return gradeNum >= 7 ? 60000 : 40000;
  }
}

    // Enhanced PDF Generation Function with Comprehensive Reporting
// Enhanced PDF Generation Function with Professional Formatting
async function generatePDFReport() {
  if (!children.length) {
    alert('No children data available to generate report.');
    return;
  }

  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Set up document properties
    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height;
    const margin = 20;
    let yPosition = margin;
    
    // Default formatting settings
    const defaultFontSize = 12;
    const lineSpacing = 1.5;
    const lineHeight = defaultFontSize * lineSpacing * 0.352778;
    
    // Helper function to add page if needed
    function checkPageBreak(requiredSpace = 20) {
      if (yPosition + requiredSpace > pageHeight - margin) {
        doc.addPage();
        yPosition = margin;
        addWatermark();
        return true;
      }
      return false;
    }
    
    // Helper function to add watermark
    function addWatermark() {
      doc.setGState(new doc.GState({opacity: 0.08}));
      doc.setFontSize(50);
      doc.setTextColor(0, 102, 255);
      doc.text('BAOBAB ACADEMY', pageWidth/2, pageHeight/2, {
        angle: 45,
        align: 'center'
      });
      doc.setGState(new doc.GState({opacity: 1}));
    }
    
    // Enhanced paragraph function with proper justification
    function writeParagraph(text, fontSize = defaultFontSize, color = [0, 0, 0], indent = 0, bold = false) {
  doc.setFontSize(fontSize);
  doc.setTextColor(...color);
  doc.setFont(undefined, bold ? 'bold' : 'normal');
  
  const currentLineHeight = fontSize * lineSpacing * 0.352778;
  const maxWidth = pageWidth - 2 * margin - indent;
  const splitText = doc.splitTextToSize(text, maxWidth);
  
  splitText.forEach((line) => {
    checkPageBreak(currentLineHeight + 5);
    // Simple left-aligned text without justification
    doc.text(line, margin + indent, yPosition);
    yPosition += currentLineHeight;
  });
  
  yPosition += currentLineHeight * 0.3;
  return splitText.length;
}
    
    // Helper function to write section header
    function writeSectionHeader(title, color = [0, 102, 255], fontSize = 14) {
      checkPageBreak(25);
      yPosition += lineHeight * 0.5;
      doc.setFontSize(fontSize);
      doc.setTextColor(...color);
      doc.setFont(undefined, 'bold');
      doc.text(title, margin, yPosition);
      yPosition += fontSize * 1.2 * 0.352778;
      doc.setFont(undefined, 'normal');
    }
    
    // Helper function to write subsection header
    function writeSubsectionHeader(title, color = [29, 181, 132], fontSize = 12) {
      checkPageBreak(20);
      yPosition += lineHeight * 0.3;
      doc.setFontSize(fontSize);
      doc.setTextColor(...color);
      doc.setFont(undefined, 'bold');
      doc.text(title, margin + 5, yPosition);
      yPosition += fontSize * 1.1 * 0.352778;
      doc.setFont(undefined, 'normal');
    }
    
    // Helper function to analyze performance from actual data
    function getPerformanceAnalysis(assessments) {
      if (!assessments.length) return null;
      
      const scores = assessments.map(a => {
        if (a.max_grade) {
          return (Number(a.grade || 0) / Number(a.max_grade)) * 100;
        }
        return Number(a.grade || 0);
      }).filter(score => score > 0);
      
      if (!scores.length) return null;
      
      const avgScore = scores.reduce((sum, score) => sum + score, 0) / scores.length;
      
      return {
        average: Math.round(avgScore),
        total: assessments.length,
        scores: scores
      };
    }
    
    // FIRST PAGE - COVER PAGE
    addWatermark();
    
    doc.setFontSize(28);
    doc.setTextColor(0, 102, 255);
    doc.setFont(undefined, 'bold');
    doc.text('BAOBAB ONLINE ACADEMY', pageWidth/2, yPosition + 20, { align: 'center' });
    yPosition += 35;
    
    doc.setFontSize(20);
    doc.setTextColor(29, 181, 132);
    doc.text('Student Progress & Assessment Report', pageWidth/2, yPosition, { align: 'center' });
    yPosition += 40;
    
    doc.setFontSize(14);
    doc.setTextColor(0, 0, 0);
    doc.setFont(undefined, 'normal');
    doc.text(`Academic Year 2024-2025`, pageWidth/2, yPosition, { align: 'center' });
    yPosition += 10;
    doc.text(`${new Date().toLocaleDateString('en-US', { 
      year: 'numeric', month: 'long', day: 'numeric' 
    })}`, pageWidth/2, yPosition, { align: 'center' });
    yPosition += 40;
    
    const personalizedGreeting = `Dear ${parentProfile?.full_name || 'Valued Parent'},`;
    writeParagraph(personalizedGreeting, 14, [0, 0, 0], 0, true);
    
    const introText = `This report provides a comprehensive overview of your ${children.length === 1 ? 'child\'s' : 'children\'s'} academic progress, including assessment results, tutor observations, and recommendations for continued growth.`;
    writeParagraph(introText, 12); // Ensure 12pt font
    
    // For each child, generate report on separate pages
    for (let childIndex = 0; childIndex < children.length; childIndex++) {
      const child = children[childIndex];
      
      doc.addPage();
      addWatermark();
      yPosition = margin;
      
      // Student Header
      doc.setFontSize(20);
      doc.setTextColor(0, 102, 255);
      doc.setFont(undefined, 'bold');
      doc.text(`${child.name.toUpperCase()}`, margin, yPosition);
      yPosition += 15;
      
      doc.setFontSize(12); // Ensure 12pt
      doc.setTextColor(0, 0, 0);
      doc.setFont(undefined, 'normal');
      doc.text(`Grade: ${child.grade_level || 'N/A'} | Class Type: ${child.class_type === 'Python Programming' ? '1-to-1' : 'Group'}`, margin, yPosition);
      yPosition += 20;
      
      // Get actual data for this child
      const childAssessments = cache.assessments.filter(a => a.children?.name === child.name);
      const childProgress = cache.progress.filter(p => p.child_name === child.name);
      const performanceData = getPerformanceAnalysis(childAssessments);
      
      // ACADEMIC PERFORMANCE SECTION
      if (performanceData) {
        writeSectionHeader('ACADEMIC PERFORMANCE', [0, 102, 255], 16);
        
        writeSubsectionHeader('Overall Score Summary');
        const scoreText = `${child.name} completed ${performanceData.total} assessments with an average score of ${performanceData.average}%. This performance demonstrates consistent engagement with academic material and shows areas of both strength and opportunity for continued growth.`;
        writeParagraph(scoreText, 12, [0, 0, 0], 10); // 12pt font, justified
        
        // Subject breakdown
        const subjectGroups = {};
        childAssessments.forEach(assessment => {
          const subject = assessment.subjects?.name || 'General Studies';
          if (!subjectGroups[subject]) {
            subjectGroups[subject] = [];
          }
          subjectGroups[subject].push(assessment);
        });
        
        Object.keys(subjectGroups).forEach(subject => {
          const subjectAssessments = subjectGroups[subject];
          const subjectPerformance = getPerformanceAnalysis(subjectAssessments);
          
          if (subjectPerformance) {
            const subjectText = `In ${subject}, the student completed ${subjectAssessments.length} assessments achieving an average of ${subjectPerformance.average}%, indicating solid understanding of subject concepts and consistent application of learned skills.`;
            writeParagraph(subjectText, 12, [60, 60, 60], 15); // 12pt font, justified
          }
        });
      }
      
      // PROGRESS OBSERVATIONS SECTION
      if (childProgress.length > 0) {
        writeSectionHeader('TUTOR OBSERVATIONS', [138, 43, 226], 16);
        
        childProgress.slice(0, 3).forEach((progress, index) => {
          checkPageBreak(30);
        
          
          // Strengths
          if (progress.strengths) {
            writeSubsectionHeader('Strengths', [29, 181, 132], 12);
            writeParagraph(progress.strengths, 12, [0, 0, 0], 15); // 12pt font, justified
          }
          
          // Areas for improvement
          if (progress.areas_of_improvement) {
            writeSubsectionHeader('Areas for Improvement', [255, 107, 53], 12);
            writeParagraph(progress.areas_of_improvement, 12, [0, 0, 0], 15); // 12pt font, justified
          }
          
          // Goals
          if (progress.goals) {
            writeSubsectionHeader('Learning Goals', [255, 152, 0], 12);
            writeParagraph(progress.goals, 12, [0, 0, 0], 15); // 12pt font, justified
          }
          
          // Additional notes
          if (progress.notes) {
            writeSubsectionHeader('Additional Notes', [100, 100, 100], 12);
            writeParagraph(progress.notes, 12, [60, 60, 60], 15); // 12pt font, justified
          }
          
          yPosition += 10; // Space between progress entries
        });
      }
      
      
      // RECOMMENDATIONS SECTION
      writeSectionHeader('RECOMMENDATIONS', [255, 152, 0], 16);
      
      if (performanceData) {
        let recommendationText = '';
        if (performanceData.average >= 80) {
          recommendationText = 'Based on the excellent performance demonstrated, we recommend continuing with advanced challenges and enrichment activities to maintain high academic standards and foster deeper conceptual understanding.';
        } else if (performanceData.average >= 60) {
          recommendationText = 'The student shows solid foundational understanding. We recommend focused practice in identified areas while building confidence through success in stronger subjects to maintain motivation and academic momentum.';
        } else {
          recommendationText = 'To support continued academic growth, we recommend implementing additional support structures including more frequent check-ins, alternative learning approaches, and collaborative goal-setting to build confidence.';
        }
        writeParagraph(recommendationText, 12, [0, 0, 0], 10, "left"); // 12pt font, justified
      }
      
      
      // Summary Box
      if (performanceData) {
        checkPageBreak(25);
        yPosition += 10;
        
        doc.setDrawColor(0, 102, 255);
        doc.setLineWidth(0.5);
        doc.rect(margin, yPosition, pageWidth - 2 * margin, 25);
        
        doc.setFontSize(12); // 12pt font for summary too
        doc.setTextColor(0, 102, 255);
        doc.setFont(undefined, 'bold');
        doc.text('SUMMARY', margin + 10, yPosition + 10);
        
        doc.setFontSize(11);
        doc.setTextColor(0, 0, 0);
        doc.setFont(undefined, 'normal');
        doc.text(`Assessments: ${performanceData.total} | Average: ${performanceData.average}% | Progress Records: ${childProgress.length}`, margin + 10, yPosition + 18);
        
        yPosition += 35;
      }
    }
    
    // Professional Closing
    doc.addPage();
    addWatermark();
    yPosition = margin + 30;
    
    writeSectionHeader('THANK YOU', [0, 102, 255], 18);
    
    const closingText = `Thank you for choosing Baobab Online Academy. We remain committed to your child's educational success and look forward to continued partnership in their learning journey. Our dedicated team of educators will continue to provide comprehensive support and regular updates on academic progress.`;
    writeParagraph(closingText, 12); // 12pt font, justified
    
    yPosition += 20;
    doc.setFontSize(12); // 12pt font
    doc.setTextColor(100, 100, 100);
    doc.setFont(undefined, 'normal');
    doc.text('Baobab Online Academy - Excellence in Digital Education', pageWidth/2, yPosition, { align: 'center' });
    yPosition += 8;
    doc.text('admin@baobabonlineacademy.com.com | www.baobabonlineacademy.com', pageWidth/2, yPosition, { align: 'center' });
    
    // Save the PDF
    const studentNames = children.map(child => child.name).join('_');
    const filename = `Baobab_Report_${studentNames.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(filename);
    
  } catch (error) {
    console.error('Error generating PDF:', error);
    alert('Failed to generate report. Please try again.');
  }
}
    // Auth functions
    async function ensureAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { 
        location.href = '/index.html'; 
        return null; 
      }
      if (!session.user.email_confirmed_at) { 
        alert('Please verify your email.'); 
        location.href = '/index.html'; 
        return null; 
      }
      currentUser = session.user;
      return currentUser;
    }

    async function loadProfile() {
      const { data: profile } = await supabase
        .from('parent_profiles')
        .select('*')
        .eq('user_id', currentUser.id)
        .maybeSingle();
        
      if (!profile) {
        const fallback = {
          user_id: currentUser.id,
          full_name: currentUser.user_metadata?.full_name || '',
          email: currentUser.email,
          phone: currentUser.user_metadata?.phone || ''
        };
        const { data: created } = await supabase
          .from('parent_profiles')
          .insert([fallback])
          .select()
          .single();
        parentProfile = created || fallback;
      } else {
        parentProfile = profile;
      }
      
      const displayName = (parentProfile.full_name?.trim()) || 
                          (currentUser.user_metadata?.full_name?.trim()) || 
                          (currentUser.email?.split('@')[0]) || 'Parent';
      const firstName = displayName.split(' ')[0];
      
      // Update UI elements
      document.getElementById('userName').textContent = displayName;
      document.getElementById('parentName').textContent = firstName;
      
      const initials = initialsOf(parentProfile.full_name || currentUser.email);
      document.getElementById('userInitials').textContent = initials;
      document.getElementById('profileInitials').textContent = initials;

      // Update profile form
      document.getElementById('profileFullName').value = parentProfile.full_name || '';
      document.getElementById('profileEmail').value = currentUser.email || '';
      document.getElementById('profilePhone').value = parentProfile.phone || '';
      document.getElementById('profileAddress').value = parentProfile.address || '';

      // Load profile image if exists
      if (parentProfile.profile_image_url) {
        const profileImg = document.getElementById('profileImage');
        const userAvatarImg = document.querySelector('#userAvatar img');
        
        profileImg.src = parentProfile.profile_image_url;
        profileImg.style.display = 'block';
        document.getElementById('profileInitials').style.display = 'none';
        
        if (userAvatarImg) {
          userAvatarImg.src = parentProfile.profile_image_url;
          userAvatarImg.style.display = 'block';
          document.getElementById('userInitials').style.display = 'none';
        } else {
          // Create img element for header avatar
          const headerAvatar = document.getElementById('userAvatar');
          const newImg = document.createElement('img');
          newImg.src = parentProfile.profile_image_url;
          newImg.alt = 'Profile';
          headerAvatar.appendChild(newImg);
          document.getElementById('userInitials').style.display = 'none';
        }
      }

      // Load parent signature if exists
      if (parentProfile.signature_url) {
        const sigImg = document.getElementById('parentSignatureImage');
        sigImg.src = parentProfile.signature_url;
        sigImg.style.display = 'block';
        document.querySelector('.signature-upload').style.display = 'none';
      }
    }

    // Profile image upload functionality
    document.querySelector('.avatar-upload').addEventListener('click', () => {
      document.getElementById('avatarInput').click();
    });

    document.getElementById('avatarInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        alert('Please select an image file.');
        return;
      }

      if (file.size > 5 * 1024 * 1024) {
        alert('File size must be less than 5MB.');
        return;
      }

      try {
        const fileExt = file.name.split('.').pop();
        const fileName = `${currentUser.id}-${Date.now()}.${fileExt}`;
        
        const { data, error } = await supabase.storage
          .from('profile-images')
          .upload(fileName, file);

        if (error) throw error;

        const { data: { publicUrl } } = supabase.storage
          .from('profile-images')
          .getPublicUrl(fileName);

        const { error: updateError } = await supabase
          .from('parent_profiles')
          .update({ 
            profile_image_url: publicUrl,
            updated_at: new Date().toISOString()
          })
          .eq('user_id', currentUser.id);

        if (updateError) throw updateError;

        // Update UI
        const profileImg = document.getElementById('profileImage');
        profileImg.src = publicUrl;
        profileImg.style.display = 'block';
        document.getElementById('profileInitials').style.display = 'none';

        const headerAvatar = document.getElementById('userAvatar');
        let headerImg = headerAvatar.querySelector('img');
        if (!headerImg) {
          headerImg = document.createElement('img');
          headerImg.alt = 'Profile';
          headerAvatar.appendChild(headerImg);
        }
        headerImg.src = publicUrl;
        headerImg.style.display = 'block';
        document.getElementById('userInitials').style.display = 'none';

        alert('Profile image updated successfully!');
      } catch (error) {
        console.error('Error uploading image:', error);
        alert('Failed to upload image. Please try again.');
      }
    });

    // Signature upload functionality
    document.getElementById('signatureInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        alert('Please select an image file.');
        return;
      }

      if (file.size > 2 * 1024 * 1024) {
        alert('Signature file size must be less than 2MB.');
        return;
      }

      try {
        const fileExt = file.name.split('.').pop();
        const fileName = `signature-${currentUser.id}-${Date.now()}.${fileExt}`;
        
        const { data, error } = await supabase.storage
          .from('signatures')
          .upload(fileName, file);

        if (error) throw error;

        const { data: { publicUrl } } = supabase.storage
          .from('signatures')
          .getPublicUrl(fileName);

        const { error: updateError } = await supabase
          .from('parent_profiles')
          .update({ 
            signature_url: publicUrl,
            agreement_signed_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
          })
          .eq('user_id', currentUser.id);

        if (updateError) throw updateError;

        // Update UI
        const sigImg = document.getElementById('parentSignatureImage');
        sigImg.src = publicUrl;
        sigImg.style.display = 'block';
        document.querySelector('.signature-upload').style.display = 'none';

        alert('Signature uploaded successfully!');
      } catch (error) {
        console.error('Error uploading signature:', error);
        alert('Failed to upload signature. Please try again.');
      }
    });

    async function loadChildren() {
      const { data, error } = await supabase
        .from('children')
        .select('*')
        .eq('parent_id', currentUser.id)
        .order('created_at', { ascending: true });
      if (error) { 
        console.error(error); 
        children = []; 
        return; 
      }
      children = data || [];
      cache.children = children;
    }

    async function loadSubjects() {
      const { data, error } = await supabase
        .from('subjects')
        .select('*')
        .eq('is_active', true)
        .order('name');
      if (error) {
        console.error('Error loading subjects:', error);
        cache.subjects = [];
        return;
      }
      cache.subjects = data || [];
    }

    async function loadDashboardStats() {
      if (!children.length) {
        document.getElementById('totalLessons').textContent = 0;
        document.getElementById('averageGrade').textContent = '0%';
        document.getElementById('culturalMilestones').textContent = 0;
        document.getElementById('activeTutors').textContent = 0;
        return;
      }
      const ids = children.map(c => c.id);

      const { data: lessons } = await supabase
        .from('lessons')
        .select('id')
        .in('child_id', ids)
        .eq('status', 'completed');
      document.getElementById('totalLessons').textContent = lessons?.length || 0;

      const { data: grades } = await supabase
        .from('assessments')
        .select('grade,max_grade')
        .in('child_id', ids);
      if (grades?.length) {
        const avg = grades.reduce((s, g) => s + (Number(g.grade) / (Number(g.max_grade) || 100)) * 100, 0) / grades.length;
        document.getElementById('averageGrade').textContent = Math.round(avg) + '%';
      } else {
        document.getElementById('averageGrade').textContent = '0%';
      }

      const { data: milestones } = await supabase
        .from('cultural_milestones')
        .select('id')
        .in('child_id', ids)
        .eq('achieved', true);
      document.getElementById('culturalMilestones').textContent = milestones?.length || 0;

      const { data: tutorAssignments } = await supabase
        .from('tutor_assignments')
        .select('tutor_id')
        .in('child_id', ids)
        .eq('status', 'active');
      const uniqueTutors = [...new Set((tutorAssignments || []).map(t => t.tutor_id))];
      document.getElementById('activeTutors').textContent = uniqueTutors.length;
    }

    // Overview widgets
    async function loadOverviewCards() {
      const cids = children.map(c => c.id);
      
      // Recent progress
      const { data: recent } = await supabase
        .from('progress_records')
        .select('score, recorded_at, children:child_id(name), subjects:subject_id(name)')
        .in('child_id', cids)
        .order('recorded_at', { ascending: false })
        .limit(5);

      const progWrap = document.getElementById('overviewProgress');
      if (!recent?.length) {
        progWrap.innerHTML = '<div class="empty-state"><i class="fas fa-chart-line"></i><div>No progress records yet.</div></div>';
      } else {
        progWrap.innerHTML = recent.map(p => `
          <div class="progress-item">
            <div class="progress-info">
              <div class="progress-title">${p.subjects?.name || 'Subject'}</div>
              <div class="progress-subtitle">${p.children?.name || 'Child'} ‚Ä¢ ${fmtDate(p.recorded_at)}</div>
            </div>
            <div class="progress-visual">
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${Number(p.score) || 0}%"></div>
              </div>
              <div class="badge badge-success">${Number(p.score) || 0}%</div>
            </div>
          </div>
        `).join('');
      }

      // Upcoming lessons - Fixed the query to show lessons after current time
      const nowIso = new Date().toISOString();
      const { data: lessons } = await supabase
        .from('lessons')
        .select('*')
        .in('child_id', cids)
        .in('status', ['scheduled', 'confirmed'])  // Include both scheduled and confirmed
        .gte('scheduled_at', nowIso)
        .order('scheduled_at', { ascending: true })
        .limit(5);

      let upcoming = [];
      if (lessons?.length) {
        const tutorIds = [...new Set(lessons.map(l => l.tutor_id).filter(Boolean))];
        const childIds = [...new Set(lessons.map(l => l.child_id).filter(Boolean))];
        const subjectIds = [...new Set(lessons.map(l => l.subject_id).filter(Boolean))];

        const [tutorResults, childResults, subjectResults] = await Promise.all([
          tutorIds.length ? supabase.from('tutor_profiles').select('id, full_name').in('id', tutorIds) : { data: [] },
          childIds.length ? supabase.from('children').select('id, name').in('id', childIds) : { data: [] },
          subjectIds.length ? supabase.from('subjects').select('id, name').in('id', subjectIds) : { data: [] }
        ]);

        const tutorMap = new Map((tutorResults.data || []).map(t => [t.id, t]));
        const childMap = new Map((childResults.data || []).map(c => [c.id, c]));
        const subjectMap = new Map((subjectResults.data || []).map(s => [s.id, s]));

        upcoming = lessons.map(lesson => ({
          ...lesson,
          tutor_name: tutorMap.get(lesson.tutor_id)?.full_name || 'Tutor',
          child_name: childMap.get(lesson.child_id)?.name || '',
          subject_name: subjectMap.get(lesson.subject_id)?.name || 'Subject'
        }));
      }

      const lessonsWrap = document.getElementById('overviewLessons');
      if (!upcoming?.length) {
        lessonsWrap.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-alt"></i><div>No upcoming lessons scheduled.</div></div>';
      } else {
        lessonsWrap.innerHTML = upcoming.map(l => {
          const dt = new Date(l.scheduled_at);
          const isToday = dt.toDateString() === new Date().toDateString();
          
          return `
            <div class="progress-item">
              <div class="progress-info">
                <div class="progress-title">${l.subject_name}</div>
                <div class="progress-subtitle">with ${l.tutor_name} ‚Ä¢ ${l.child_name}</div>
              </div>
              <div class="progress-visual" style="gap: 0.75rem;">
                <div class="badge badge-warning">${isToday ? 'Today' : fmtDate(l.scheduled_at)} ${fmtTime(l.scheduled_at)}</div>
                ${isToday && l.meeting_url ? 
                  `<a class="btn btn-success btn-sm" href="${l.meeting_url}" target="_blank" rel="noopener"><i class="fas fa-video"></i> Join</a>` : 
                  `<span class="badge badge-secondary">${l.status || 'Scheduled'}</span>`
                }
              </div>
            </div>
          `;
        }).join('');
      }
    }

    // Agreement functionality
    async function loadAgreementSection() {
      if (!parentProfile || !children.length) {
        document.getElementById('agreementDocument').innerHTML = `
          <div class="empty-state">
            <i class="fas fa-file-contract"></i>
            <div>Agreement data not available. Please ensure your profile and children information is complete.</div>
          </div>
        `;
        return;
      }

      try {
        // Set basic info - use parent registration date
        const registrationDate = new Date(currentUser.created_at);
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        
        document.getElementById('agreementDate').textContent = registrationDate.getDate();
        document.getElementById('agreementMonth').textContent = months[registrationDate.getMonth()];
        document.getElementById('parentNameAgreement').textContent = parentProfile.full_name || 'Parent Name';
        document.getElementById('parentSignatureName').textContent = parentProfile.full_name || 'Parent Name';
        
        // Format registration date for signatures
        document.getElementById('parentSignatureDate').textContent = registrationDate.toLocaleDateString();
        document.getElementById('schoolSignatureDate').textContent = registrationDate.toLocaleDateString();

        // Format children list - fix double grade issue
        const childrenList = children.map(child => {
          const grade = child.grade_level ? ` (${child.grade_level})` : '';
          return `<strong>${child.name}</strong>${grade}`;
        }).join(' and ');
        document.getElementById('childrenListAgreement').innerHTML = childrenList;

        // Load tutor assignments and subjects for children
        const childIds = children.map(c => c.id);
        const { data: assignments } = await supabase
          .from('tutor_assignments')
          .select('*')
          .in('child_id', childIds)
          .eq('status', 'active');

        let subjectsEnrollment = '';
        let tutorAssignments = '';
        let totalFees = 0;

        if (assignments?.length) {
          const tutorIds = [...new Set(assignments.map(a => a.tutor_id).filter(Boolean))];
          const subjectIds = [...new Set(assignments.map(a => a.subject_id).filter(Boolean))];

          const [tutorResults, subjectResults] = await Promise.all([
            tutorIds.length ? supabase.from('tutor_profiles').select('id, full_name').in('id', tutorIds) : { data: [] },
            subjectIds.length ? supabase.from('subjects').select('id, name, weekly_frequency').in('id', subjectIds) : { data: [] }
          ]);

          const tutorMap = new Map((tutorResults.data || []).map(t => [t.id, t]));
          const subjectMap = new Map((subjectResults.data || []).map(s => [s.id, s]));

          // Group subjects by frequency
          const subjectGroups = {};
          assignments.forEach(assignment => {
            const subject = subjectMap.get(assignment.subject_id);
            if (subject) {
              const frequency = subject.weekly_frequency || 2;
              const key = `${subject.name}_${frequency}`;
              if (!subjectGroups[key]) {
                subjectGroups[key] = {
                  name: subject.name,
                  frequency: frequency,
                  tutors: new Set()
                };
              }
              const tutor = tutorMap.get(assignment.tutor_id);
              if (tutor) {
                subjectGroups[key].tutors.add(tutor.full_name);
              }
            }
          });

          // Build subjects enrollment text
          const subjectEntries = Object.values(subjectGroups);
          subjectsEnrollment = `<p>The children are enrolled in:</p><ul class="agreement-list">`;
          
          let totalPeriods = 0;
          subjectEntries.forEach(subject => {
            const periodsText = subject.frequency === 1 ? '1 period weekly' : `${subject.frequency} periods weekly`;
            subjectsEnrollment += `<li><strong>${subject.name}</strong> (${periodsText})</li>`;
            totalPeriods += subject.frequency;
          });
          
          subjectsEnrollment += `</ul><p><strong>Total weekly periods: ${totalPeriods}</strong></p>`;

          // Build tutor assignments
          tutorAssignments = '<p>Subject assignments:</p><ul class="agreement-list">';
          subjectEntries.forEach(subject => {
            const tutorsList = Array.from(subject.tutors).join(' and ');
            tutorAssignments += `<li><strong>${subject.name}</strong> will be taught by ${tutorsList}.</li>`;
          });
          tutorAssignments += '</ul>';

          // Add supporting tutors information
          const supportingTutorsInfo = children
            .filter(child => child.supporting_tutors && child.supporting_tutors.length > 0)
            .map(child => {
              const tutorsList = child.supporting_tutors.join(' and ');
              return `<li>Lessons for <strong>${child.name}</strong> will be supported by ${tutorsList} as assistant teachers.</li>`;
            })
            .join('');
          
          if (supportingTutorsInfo) {
            tutorAssignments += '<p>Additional support:</p><ul class="agreement-list">' + supportingTutorsInfo + '</ul>';
          }

        } else {
          subjectsEnrollment = '<p><em>No active subject enrollments found.</em></p>';
          tutorAssignments = '<p><em>No tutor assignments found.</em></p>';
        }

        // Calculate fees based on each child's grade and class type
        children.forEach(child => {
          const fee = getFeeForChild(child);
          totalFees += fee;
        });

        // Update agreement content
        document.getElementById('subjectsEnrollmentAgreement').innerHTML = subjectsEnrollment;
        document.getElementById('tutorAssignmentsAgreement').innerHTML = tutorAssignments;

        // Update fees with proper calculation
        const totalFeesFormatted = new Intl.NumberFormat('en-NG', {
          style: 'currency',
          currency: 'NGN',
          minimumFractionDigits: 0
        }).format(totalFees);

        const feesInWords = numberToWords(totalFees);
        
        // Build detailed fees breakdown
        let feesBreakdown = '<p>Fee breakdown per child:</p><ul class="agreement-list">';
        children.forEach(child => {
          const fee = getFeeForChild(child);
          const feeFormatted = new Intl.NumberFormat('en-NG', {
            style: 'currency',
            currency: 'NGN',
            minimumFractionDigits: 0
          }).format(fee);
          feesBreakdown += `<li><strong>${child.name}</strong> (${child.class_type || 'Group'} class): ${feeFormatted} per month</li>`;
        });
        feesBreakdown += '</ul>';
        
        feesBreakdown += `<p><strong>Total due for ${children.length} ${children.length === 1 ? 'child' : 'children'} = ${totalFeesFormatted}</strong> (${feesInWords} Naira only) per month.</p>`;
        
        document.getElementById('feesBreakdownAgreement').innerHTML = feesBreakdown;

      } catch (error) {
        console.error('Error loading agreement:', error);
        document.getElementById('agreementDocument').innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <div>Error loading agreement data. Please refresh the page and try again.</div>
          </div>
        `;
      }
    }

    // Print agreement functionality
    document.getElementById('printAgreement')?.addEventListener('click', () => {
      window.print();
    });

    // Download PDF functionality
    document.getElementById('downloadAgreementPDF')?.addEventListener('click', () => {
      alert('Please use your browser\'s "Print to PDF" option from the print dialog for now. Full PDF download functionality will be added soon.');
      window.print();
    });

    // Table renderers
    function renderChildrenTable(rows) {
      const tb = document.getElementById('childrenTbody');
      if (!rows?.length) { 
        tb.innerHTML = `<tr><td colspan="10"><div class="empty-state"><i class="fas fa-child"></i><div>No children found.</div></div></td></tr>`; 
        return; 
      }
      tb.innerHTML = rows.map(r => `
        <tr>
          <td data-label="Name">${r.name || ''}</td>
          <td data-label="DOB">${fmtDate(r.date_of_birth)}</td>
          <td data-label="Age">${yearsFrom(r.date_of_birth) || ''}</td>
          <td data-label="Grade">${r.grade_level || ''}</td>
          <td data-label="Class Type"><span class="badge badge-primary">${r.class_type || 'Group'}</span></td>
          <td data-label="Status">${statusBadge(r.status || 'Active')}</td>
          <td data-label="Enrolled">${fmtDate(r.enrollment_date)}</td>
          <td data-label="Emergency Contact">${r.emergency_contact || '‚Äî'}</td>
          <td data-label="Supporting Tutors">${r.supporting_tutors ? r.supporting_tutors.join(', ') : '‚Äî'}</td>
          <td data-label="Actions">
            <button class="btn btn-warning btn-sm" onclick="openChildEditModal('${r.id}')">
              <i class="fas fa-edit"></i> Edit
            </button>
          </td>
        </tr>
      `).join('');
    }

    function renderLessonsTable(rows) {
      const tb = document.getElementById('lessonsTbody');
      if (!rows?.length) { 
        tb.innerHTML = `<tr><td colspan="7"><div class="empty-state"><i class="fas fa-calendar-alt"></i><div>No lessons found.</div></div></td></tr>`; 
        return; 
      }
      tb.innerHTML = rows.map(r => `
        <tr>
          <td data-label="Date">${fmtDate(r.scheduled_at)}</td>
          <td data-label="Time">${fmtTime(r.scheduled_at)}</td>
          <td data-label="Child">${r.child_name || ''}</td>
          <td data-label="Subject">${r.subject_name || ''}</td>
          <td data-label="Tutor">${r.tutor_name || ''}</td>
          <td data-label="Status">${statusBadge(r.status)}</td>
          <td data-label="Join">
            ${r.meeting_url ? 
              `<a class="btn btn-success btn-sm" href="${r.meeting_url}" target="_blank" rel="noopener"><i class="fas fa-video"></i> Join</a>` : 
              '<span class="badge badge-secondary">‚Äî</span>'
            }
          </td>
        </tr>
      `).join('');
    }

    function renderTutorsTable(rows) {
      const tb = document.getElementById('tutorsTbody');
      if (!rows?.length) { 
        tb.innerHTML = `<tr><td colspan="4"><div class="empty-state"><i class="fas fa-chalkboard-teacher"></i><div>No tutor found.</div></div></td></tr>`; 
        return; 
      }
      tb.innerHTML = rows.map(r => `
        <tr>
          <td data-label="Tutor">${r.tutor_name || ''}</td>
          <td data-label="Child">${r.child_name || ''}</td>
          <td data-label="Subject">${r.subject_name || ''}</td>
          <td data-label="Status">${statusBadge(r.status || 'Active')}</td>
        </tr>
      `).join('');
    }

    function renderAssessmentsTable(rows) {
      const tb = document.getElementById('assessmentsTbody');
      if (!rows?.length) { 
        tb.innerHTML = `<tr><td colspan="7"><div class="empty-state"><i class="fas fa-chart-bar"></i><div>No assessments recorded.</div></div></td></tr>`; 
        return; 
      }
      tb.innerHTML = rows.map(a => {
        const pct = toPercent(a.grade, a.max_grade);
        const scoreStr = (a.grade != null ? a.grade : '‚Äî') + (a.max_grade ? ` / ${a.max_grade}` : '') + (pct ? ` (${pct})` : '');
        return `
          <tr>
            <td data-label="Date">${fmtDate(a.conducted_at)}</td>
            <td data-label="Child">${a.children?.name || ''}</td>
            <td data-label="Subject">${a.subjects?.name || ''}</td>
            <td data-label="Title">${a.title || ''}</td>
            <td data-label="Type"><span class="badge badge-secondary">${a.type || 'quiz'}</span></td>
            <td data-label="Score">${scoreStr}</td>
            <td data-label="Feedback">${createExpandableText(a.feedback)}</td>
          </tr>
        `;
      }).join('');
    }

    function renderProgressTable(rows) {
  const tb = document.getElementById('progressTbody');
  if (!rows?.length) { 
    tb.innerHTML = `<tr><td colspan="8"><div class="empty-state"><i class="fas fa-chart-line"></i><div>No progress records yet.</div></div></td></tr>`; 
    return; 
  }
  tb.innerHTML = rows.map(p => `
    <tr>
      <td data-label="Date">${fmtDate(p.recorded_at)}</td>
      <td data-label="Child">${p.child_name || ''}</td>
      <td data-label="Subject">${p.subject_name || ''}</td>
      <td data-label="Score">${p.score != null ? p.score + '%' : '‚Äî'}</td>
      <td data-label="Strengths">${createExpandableText(p.strengths, 100)}</td>
      <td data-label="Improvement">${createExpandableText(p.areas_of_improvement, 100)}</td>
      <td data-label="Notes">${createExpandableText(p.notes, 100)}</td>
      <td data-label="Recorded By">${p.tutor_name || '‚Äî'}</td>
    </tr>
  `).join('');
}

    function renderBillingTable(rows) {
      const tb = document.getElementById('billingTbody');
      if (!rows?.length) { 
        tb.innerHTML = `<tr><td colspan="8"><div class="empty-state"><i class="fas fa-file-invoice-dollar"></i><div>No billing records yet.</div></div></td></tr>`; 
        return; 
      }
      tb.innerHTML = rows.map(b => `
        <tr>
          <td data-label="Created">${fmtDate(b.created_at)}</td>
          <td data-label="Description">${b.description || ''}</td>
          <td data-label="Amount">${b.currency || 'GBP'} ${Number(b.amount || 0).toFixed(2)}</td>
          <td data-label="Status">${statusBadge(b.status || 'pending')}</td>
          <td data-label="Due">${fmtDate(b.due_date)}</td>
          <td data-label="Paid At">${fmtDate(b.paid_at)}</td>
          <td data-label="Method">${b.payment_method || '‚Äî'}</td>
          <td data-label="Txn ID">${b.transaction_id || '‚Äî'}</td>
        </tr>
      `).join('');
    }

    // Section loaders
    async function loadChildrenSection() {
      renderChildrenTable(cache.children);
    }

    async function loadLessonsSection() {
      if (!children.length) { 
        renderLessonsTable([]); 
        return; 
      }
      
      const ids = children.map(c => c.id);
      const { data: lessons } = await supabase
        .from('lessons')
        .select('*')
        .in('child_id', ids)
        .order('scheduled_at', { ascending: true });

      let data = [];
      if (lessons?.length) {
        const tutorIds = [...new Set(lessons.map(l => l.tutor_id).filter(Boolean))];
        const childIds = [...new Set(lessons.map(l => l.child_id).filter(Boolean))];
        const subjectIds = [...new Set(lessons.map(l => l.subject_id).filter(Boolean))];

        const [tutorResults, childResults, subjectResults] = await Promise.all([
          tutorIds.length ? supabase.from('tutor_profiles').select('id, full_name').in('id', tutorIds) : { data: [] },
          childIds.length ? supabase.from('children').select('id, name').in('id', childIds) : { data: [] },
          subjectIds.length ? supabase.from('subjects').select('id, name').in('id', subjectIds) : { data: [] }
        ]);

        const tutorMap = new Map((tutorResults.data || []).map(t => [t.id, t]));
        const childMap = new Map((childResults.data || []).map(c => [c.id, c]));
        const subjectMap = new Map((subjectResults.data || []).map(s => [s.id, s]));

        data = lessons.map(lesson => ({
          ...lesson,
          tutor_name: tutorMap.get(lesson.tutor_id)?.full_name,
          child_name: childMap.get(lesson.child_id)?.name,
          subject_name: subjectMap.get(lesson.subject_id)?.name
        }));
      }

      cache.lessons = data || [];
      renderLessonsTable(cache.lessons);
    }

    async function loadTutorsSection() {
      if (!children.length) { 
        renderTutorsTable([]); 
        return; 
      }
      
      const ids = children.map(c => c.id);
      const { data: assignments } = await supabase
        .from('tutor_assignments')
        .select('*')
        .in('child_id', ids)
        .order('created_at', { ascending: false });

      let data = [];
      if (assignments?.length) {
        const tutorIds = [...new Set(assignments.map(a => a.tutor_id).filter(Boolean))];
        const childIds = [...new Set(assignments.map(a => a.child_id).filter(Boolean))];
        const subjectIds = [...new Set(assignments.map(a => a.subject_id).filter(Boolean))];

        const [tutorResults, childResults, subjectResults] = await Promise.all([
          tutorIds.length ? supabase.from('tutor_profiles').select('id, full_name, email').in('id', tutorIds) : { data: [] },
          childIds.length ? supabase.from('children').select('id, name').in('id', childIds) : { data: [] },
          subjectIds.length ? supabase.from('subjects').select('id, name').in('id', subjectIds) : { data: [] }
        ]);

        const tutorMap = new Map((tutorResults.data || []).map(t => [t.id, t]));
        const childMap = new Map((childResults.data || []).map(c => [c.id, c]));
        const subjectMap = new Map((subjectResults.data || []).map(s => [s.id, s]));

        data = assignments.map(assignment => ({
          ...assignment,
          tutor_name: tutorMap.get(assignment.tutor_id)?.full_name,
          child_name: childMap.get(assignment.child_id)?.name,
          subject_name: subjectMap.get(assignment.subject_id)?.name
        }));
      }

      cache.tutors = data || [];
      renderTutorsTable(cache.tutors);
    }

    async function loadReportsSection() {
      if (!children.length) {
        renderAssessmentsTable([]); 
        renderProgressTable([]);
        if (charts.avgBySubject) { 
          charts.avgBySubject.destroy(); 
          charts.avgBySubject = null; 
        }
        if (charts.trend) { 
          charts.trend.destroy(); 
          charts.trend = null; 
        }
        return;
      }
      const ids = children.map(c => c.id);
      
      // Assessments
      const { data: assessments } = await supabase
        .from('assessments')
        .select('id, grade, max_grade, title, type, feedback, conducted_at, children:child_id(name), subjects:subject_id(name)')
        .in('child_id', ids)
        .order('conducted_at', { ascending: false });
      cache.assessments = assessments || [];
      renderAssessmentsTable(cache.assessments);

      // Charts: averages by subject
      const bySubject = {};
      (cache.assessments).forEach(a => {
        const s = a.subjects?.name || 'Subject';
        const pct = a.max_grade ? (Number(a.grade || 0) / Number(a.max_grade)) * 100 : Number(a.grade || 0);
        if (!bySubject[s]) bySubject[s] = { sum: 0, count: 0 };
        bySubject[s].sum += pct; 
        bySubject[s].count += 1;
      });
      const subjectAverages = Object.entries(bySubject).map(([subject, agg]) => ({ 
        subject, 
        avg: Math.round(agg.sum / agg.count) 
      }));
      
      const ctx1 = document.getElementById('avgBySubjectChart').getContext('2d');
      if (charts.avgBySubject) charts.avgBySubject.destroy();
      charts.avgBySubject = new Chart(ctx1, {
        type: 'bar',
        data: { 
          labels: subjectAverages.map(s => s.subject), 
          datasets: [{ 
            data: subjectAverages.map(s => s.avg), 
            label: 'Average %', 
            backgroundColor: 'rgba(29, 181, 132, 0.8)', 
            borderColor: 'rgba(29, 181, 132, 1)', 
            borderWidth: 2, 
            borderRadius: 8,
            borderSkipped: false,
          }] 
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: false, 
          scales: { 
            y: { 
              beginAtZero: true, 
              max: 100, 
              ticks: { callback: v => v + '%' },
              grid: { color: 'rgba(226, 232, 240, 0.5)' }
            },
            x: {
              grid: { display: false }
            }
          }, 
          plugins: { 
            legend: { display: false },
            title: {
              display: true,
              text: 'Average Scores by Subject',
              font: { size: 14, weight: '600' },
              color: '#1E293B'
            }
          }
        }
      });

      // Trend: last 12
      const last = (cache.assessments).slice(0, 12).reverse();
      const trend = last.map(a => ({ 
        label: fmtDate(a.conducted_at), 
        value: Math.round((Number(a.grade || 0) / (Number(a.max_grade) || 100)) * 100) 
      }));
      
      const ctx2 = document.getElementById('trendChart').getContext('2d');
      if (charts.trend) charts.trend.destroy();
      charts.trend = new Chart(ctx2, {
        type: 'line',
        data: { 
          labels: trend.map(t => t.label), 
          datasets: [{ 
            data: trend.map(t => t.value), 
            label: 'Score %', 
            borderColor: '#0066FF', 
            backgroundColor: 'rgba(0, 102, 255, 0.1)', 
            tension: 0.4, 
            fill: true, 
            pointRadius: 4,
            pointBackgroundColor: '#0066FF',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2
          }] 
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: false, 
          scales: { 
            y: { 
              beginAtZero: true, 
              max: 100, 
              ticks: { callback: v => v + '%' },
              grid: { color: 'rgba(226, 232, 240, 0.5)' }
            },
            x: {
              grid: { display: false }
            }
          }, 
          plugins: { 
            legend: { display: false },
            title: {
              display: true,
              text: 'Recent Assessment Trend',
              font: { size: 14, weight: '600' },
              color: '#1E293B'
            }
          }
        }
      });

      // Progress records
      const { data: progressRecords } = await supabase
        .from('progress_records')
        .select('*')
        .in('child_id', ids)
        .order('recorded_at', { ascending: false });

      let progressData = [];
      if (progressRecords?.length) {
        const tutorIds = [...new Set(progressRecords.map(p => p.recorded_by).filter(Boolean))];
        const childIds = [...new Set(progressRecords.map(p => p.child_id).filter(Boolean))];
        const subjectIds = [...new Set(progressRecords.map(p => p.subject_id).filter(Boolean))];

        const [tutorResults, childResults, subjectResults] = await Promise.all([
          tutorIds.length ? supabase.from('tutor_profiles').select('id, full_name').in('id', tutorIds) : { data: [] },
          childIds.length ? supabase.from('children').select('id, name').in('id', childIds) : { data: [] },
          subjectIds.length ? supabase.from('subjects').select('id, name').in('id', subjectIds) : { data: [] }
        ]);

        const tutorMap = new Map((tutorResults.data || []).map(t => [t.id, t]));
        const childMap = new Map((childResults.data || []).map(c => [c.id, c]));
        const subjectMap = new Map((subjectResults.data || []).map(s => [s.id, s]));

        progressData = progressRecords.map(record => ({
          ...record,
          tutor_name: tutorMap.get(record.recorded_by)?.full_name,
          child_name: childMap.get(record.child_id)?.name,
          subject_name: subjectMap.get(record.subject_id)?.name
        }));
      }
      
      cache.progress = progressData;
      renderProgressTable(cache.progress);
    }

    async function loadBillingSection() {
      const { data, error } = await supabase
        .from('billing_records')
        .select('*')
        .eq('parent_id', currentUser.id)
        .order('created_at', { ascending: false });
      if (error) { 
        console.error(error); 
        renderBillingTable([]); 
        return; 
      }
      cache.billing = data || [];
      renderBillingTable(cache.billing);
    }

    // Section dispatcher
    async function loadSection(id) {
      switch (id) {
        case 'overview':
          await loadDashboardStats();
          await loadOverviewCards();
          break;
        case 'children':
          await loadChildrenSection();
          break;
        case 'lessons':
          await loadLessonsSection();
          break;
        case 'tutors':
          await loadTutorsSection();
          break;
        case 'reports':
          await loadReportsSection();
          break;
        case 'billing':
          await loadBillingSection();
          break;
        case 'agreement':
          await loadAgreementSection();
          break;
        case 'profile':
        default:
          break;
      }
    }

    // Child modal functions
    function openChildEditModal(id) {
      const c = children.find(x => x.id === id);
      if (!c) return;
      document.getElementById('editChildId').value = c.id;
      document.getElementById('editChildName').value = c.name || '';
      document.getElementById('editChildDOB').value = c.date_of_birth || '';
      document.getElementById('editChildGrade').value = c.grade_level || '';
      document.getElementById('editChildClassType').value = c.class_type || 'Group';
      document.getElementById('editChildEmergency').value = c.emergency_contact || '';
      document.getElementById('editChildMedical').value = c.medical_info || '';
      document.getElementById('editChildPreferences').value = c.learning_preferences || '';
      
      // Handle supporting tutors array
      const supportingTutors = c.supporting_tutors ? c.supporting_tutors.join(', ') : '';
      document.getElementById('editChildSupportingTutors').value = supportingTutors;
      
      document.getElementById('childEditModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeChildEditModal() {
      document.getElementById('childEditModal').classList.remove('active');
      document.body.style.overflow = '';
    }

    async function saveChild(e) {
      e.preventDefault();
      const id = document.getElementById('editChildId').value;
      
      // Handle supporting tutors conversion from string to array
      const supportingTutorsString = document.getElementById('editChildSupportingTutors').value;
      const supportingTutorsArray = supportingTutorsString 
        ? supportingTutorsString.split(',').map(name => name.trim()).filter(name => name.length > 0)
        : null;
      
      const updates = {
        name: document.getElementById('editChildName').value,
        date_of_birth: document.getElementById('editChildDOB').value || null,
        grade_level: document.getElementById('editChildGrade').value,
        class_type: document.getElementById('editChildClassType').value,
        emergency_contact: document.getElementById('editChildEmergency').value,
        medical_info: document.getElementById('editChildMedical').value,
        learning_preferences: document.getElementById('editChildPreferences').value,
        supporting_tutors: supportingTutorsArray,
        updated_at: new Date().toISOString()
      };
      
      const { error } = await supabase.from('children').update(updates).eq('id', id);
      if (error) { 
        alert('Failed to update child.'); 
        return; 
      }
      alert('Child updated successfully!');
      closeChildEditModal();
      await loadChildren();
      await loadChildrenSection();
      await loadOverviewCards();
      await loadReportsSection();
      await loadAgreementSection();
    }

    // Profile save
    async function saveProfile(e) {
      e.preventDefault();
      const updates = {
        full_name: document.getElementById('profileFullName').value,
        phone: document.getElementById('profilePhone').value,
        address: document.getElementById('profileAddress').value,
        updated_at: new Date().toISOString()
      };
      const { error } = await supabase.from('parent_profiles').update(updates).eq('user_id', currentUser.id);
      if (error) { 
        alert('Failed to update profile.'); 
        return; 
      }
      alert('Profile updated successfully!');
      await loadProfile();
      await loadAgreementSection();
    }

    // Search and export hooks
    function hookSearch(inputId, rowsGetter, renderFn, keys) {
      const input = document.getElementById(inputId);
      if (!input) return;
      input.addEventListener('input', () => {
        const q = input.value.trim().toLowerCase();
        const base = rowsGetter();
        if (!q) { 
          renderFn(base); 
          return; 
        }
        const filtered = base.filter(row => {
          return keys.some(k => {
            const val = typeof k === 'function' ? k(row) : row[k];
            return String(val || '').toLowerCase().includes(q);
          });
        });
        renderFn(filtered);
      });
    }

    function hookExport(btnId, filename, rowsGetter, columns) {
      const btn = document.getElementById(btnId);
      if (!btn) return;
      btn.addEventListener('click', () => {
        const rows = rowsGetter();
        exportCSV(filename, rows, columns);
      });
    }

    // Event listeners
    document.getElementById('logoutLink')?.addEventListener('click', async (e) => {
      e.preventDefault();
      await supabase.auth.signOut();
      location.href = '/index.html';
    });

    document.getElementById('childEditForm')?.addEventListener('submit', saveChild);
    document.getElementById('profileForm')?.addEventListener('submit', saveProfile);
    document.getElementById('refreshReports')?.addEventListener('click', loadReportsSection);

    // PDF Download Event Listener
    document.getElementById('downloadReportsPDF')?.addEventListener('click', generatePDFReport);

    // Search + Export bindings
    hookSearch('childrenSearch', () => cache.children, renderChildrenTable, ['name', 'grade_level', 'status', 'emergency_contact', 'class_type', r => r.supporting_tutors?.join(' ')]);
    hookExport('childrenExport', 'children.csv', () => cache.children, [
      { label: 'Name', key: 'name' },
      { label: 'DOB', get: r => fmtDate(r.date_of_birth) },
      { label: 'Age', get: r => yearsFrom(r.date_of_birth) },
      { label: 'Grade', key: 'grade_level' },
      { label: 'Class Type', key: 'class_type' },
      { label: 'Status', key: 'status' },
      { label: 'Enrolled', get: r => fmtDate(r.enrollment_date) },
      { label: 'Emergency', key: 'emergency_contact' },
      { label: 'Supporting Tutors', get: r => r.supporting_tutors?.join(', ') || '' }
    ]);

    hookSearch('lessonsSearch', () => cache.lessons, renderLessonsTable, [
      'child_name', 'subject_name', 'tutor_name', 'status'
    ]);
    hookExport('lessonsExport', 'lessons.csv', () => cache.lessons, [
      { label: 'Date', get: r => fmtDate(r.scheduled_at) },
      { label: 'Time', get: r => fmtTime(r.scheduled_at) },
      { label: 'Child', key: 'child_name' },
      { label: 'Subject', key: 'subject_name' },
      { label: 'Tutor', key: 'tutor_name' },
      { label: 'Status', key: 'status' },
      { label: 'Meeting URL', key: 'meeting_url' }
    ]);

    hookSearch('tutorsSearch', () => cache.tutors, renderTutorsTable, [
      'tutor_name', 'child_name', 'subject_name', 'status'
    ]);
    hookExport('tutorsExport', 'tutors.csv', () => cache.tutors, [
      { label: 'Tutor', key: 'tutor_name' },
      { label: 'Child', key: 'child_name' },
      { label: 'Subject', key: 'subject_name' },
      { label: 'Status', key: 'status' }
    ]);

    hookSearch('assessmentsSearch', () => cache.assessments, renderAssessmentsTable, [
      r => r.children?.name, r => r.subjects?.name, 'title', 'type', 'feedback'
    ]);
    hookExport('assessmentsExport', 'assessments.csv', () => cache.assessments, [
      { label: 'Date', get: r => fmtDate(r.conducted_at) },
      { label: 'Child', get: r => r.children?.name },
      { label: 'Subject', get: r => r.subjects?.name },
      { label: 'Title', key: 'title' },
      { label: 'Type', key: 'type' },
      { label: 'Grade', get: r => r.grade },
      { label: 'Max Grade', get: r => r.max_grade },
      { label: 'Feedback', key: 'feedback' }
    ]);

    hookSearch('progressSearch', () => cache.progress, renderProgressTable, [
      'child_name', 'subject_name', 'strengths','notes', 'areas_of_improvement'
    ]);
    hookExport('progressExport', 'progress_records.csv', () => cache.progress, [
      { label: 'Date', get: r => fmtDate(r.recorded_at) },
      { label: 'Child', key: 'child_name' },
      { label: 'Subject', key: 'subject_name' },
      { label: 'Score', get: r => r.score },
      { label: 'Strengths', get: r => r.strengths },
      { label: 'notes', get: r => r.notes },
      { label: 'Improvement', get: r => r.areas_of_improvement },
      { label: 'Recorded By', key: 'tutor_name' }
    ]);

    hookSearch('billingSearch', () => cache.billing, renderBillingTable, [
      'description', 'status', 'payment_method', 'transaction_id', 'currency'
    ]);
    hookExport('billingExport', 'billing.csv', () => cache.billing, [
      { label: 'Created', get: r => fmtDate(r.created_at) },
      { label: 'Description', key: 'description' },
      { label: 'Amount', get: r => Number(r.amount || 0).toFixed(2) },
      { label: 'Currency', key: 'currency' },
      { label: 'Status', key: 'status' },
      { label: 'Due Date', get: r => fmtDate(r.due_date) },
      { label: 'Paid At', get: r => fmtDate(r.paid_at) },
      { label: 'Payment Method', key: 'payment_method' },
      { label: 'Transaction ID', key: 'transaction_id' }
    ]);

    // Global search
    document.getElementById('globalSearch')?.addEventListener('input', (e) => {
      const q = e.target.value.toLowerCase();
      if (location.hash.replace('#', '') !== 'children') { 
        location.hash = '#children'; 
      }
      const base = cache.children;
      const filtered = q ? base.filter(r => 
        [r.name, r.grade_level, r.status, r.emergency_contact, r.class_type].some(v => 
          String(v || '').toLowerCase().includes(q)
        )
      ) : base;
      renderChildrenTable(filtered);
    });

    // Notifications placeholder
    document.getElementById('notificationBtn')?.addEventListener('click', () => {
      alert('Notifications coming soon!');
    });

    // Auth listener
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_OUT' || !session) { 
        location.href = '/index.html'; 
      }
    });

    // Make modal functions global
    window.openChildEditModal = openChildEditModal;
    window.closeChildEditModal = closeChildEditModal;

    // Boot
    (async function init() {
      const user = await ensureAuth(); 
      if (!user) return;
      
      await loadProfile();
      await loadChildren();
      await loadSubjects();
      await initializeFeesTable();

      // Initial route
      routeFromHash();

      // Preload data for better UX
      loadDashboardStats();
      loadOverviewCards();
      loadLessonsSection();
      loadTutorsSection();
      loadReportsSection();
      loadBillingSection();
      loadAgreementSection();
    })();
  </script>
</body>
</html>